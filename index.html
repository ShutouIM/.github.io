<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Timing Lock: Ultimate PC Edition</title>
    <style>
        /* --- ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ --- */
        @font-face {
            font-family: 'DenkiChip';
            src: url('x8y12pxDenkiChip.ttf') format('truetype');
        }

        body {
            margin: 0; background-color: #080808; color: white;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            min-height: 100vh; user-select: none; overflow-x: hidden;
            transition: font-family 0.3s;
            display: flex; flex-direction: column;
            touch-action: manipulation; /* ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã‚ºãƒ¼ãƒ é˜²æ­¢ */
        }

        /* --- ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ --- */
        #title-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #080808; z-index: 200; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }
        #title-name {
            font-family: 'DenkiChip', sans-serif; /* ã‚¿ã‚¤ãƒˆãƒ«ã«ãƒ•ã‚©ãƒ³ãƒˆé©ç”¨ */
            font-size: clamp(40px, 8vw, 60px); color: #ff0055; margin: 0 0 10px 0; text-shadow: 0 0 20px #ff0055;
            letter-spacing: 4px; text-align: center;
        }
        #title-sub {
            font-family: 'DenkiChip', sans-serif; /* ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«ã«ã‚‚é©ç”¨ */
            color:#d0ff00; font-size: clamp(18px, 4vw, 32px); margin-top:-10px; letter-spacing: 2px; text-align: center;
        }
        #btn-start {
            margin-top: 40px; padding: 15px 50px; font-size: 22px; background: linear-gradient(135deg, #00ffcc, #0088aa);
            border: none; border-radius: 10px; color: #000; font-weight: bold; cursor: pointer;
            box-shadow: 0 0 15px #00ffcc; transition: transform 0.1s;
        }
        #btn-start:active { transform: scale(0.95); }

        /* --- PCå‘ã‘ 3ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
        .layout-container {
            display: none; 
            flex-direction: row; justify-content: center; align-items: stretch;
            gap: 40px; width: 100%; max-width: 1200px; margin: 0 auto; 
            box-sizing: border-box; flex-grow: 1; padding-bottom: 40px;
        }
        .panel { display: flex; flex-direction: column; }
        
        .left-panel { width: 280px; gap: 15px; justify-content: flex-end; }
        .center-panel { width: 340px; align-items: center; justify-content: flex-start; padding-top: 5vh; }
        .right-panel { width: 280px; gap: 15px; justify-content: flex-end; }

        /* --- å·¦ãƒ‘ãƒãƒ«ï¼šãƒ¬ã‚³ãƒ¼ãƒ‰ãƒ»æ™‚è¨ˆãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ --- */
        .record-box { background: #151515; border: 1px solid #333; padding: 15px; border-radius: 12px; width: 100%; box-sizing: border-box; font-size: 16px; font-weight: bold; color: #aaa; margin-bottom: auto; }
        .record-line { display: flex; justify-content: space-between; margin-top: 8px; }
        .record-line span { color: #fff; font-size: 22px; }

        #clock-sidebar { display: flex; flex-direction: column; gap: 8px; align-items: center; width: 100%; margin-bottom: 10px; }
        .mini-clock { width: 36px; height: 36px; border: 2px solid #00ffcc; border-radius: 50%; background: rgba(0,0,0,0.5); position: relative; }
        .mini-clock::after { content:''; display:block; width:2px; height:14px; background:#00ffcc; position:absolute; top:4px; left:17px; transform-origin:bottom center; animation: tick linear infinite; }
        @keyframes tick { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .stats-box { background: #151515; border: 1px solid #333; padding: 15px; border-radius: 12px; width: 100%; box-sizing: border-box; font-size: 18px; font-weight: bold; color: #00ffcc; line-height: 2.0; }
        .stat-line { display: flex; justify-content: space-between; align-items: center; }
        .life-container { display: flex; gap: 4px; flex-wrap: wrap; justify-content: flex-end; }
        .life-box { width: 20px; height: 20px; background: #00cc55; border: 1px solid #005522; border-radius: 4px; }
        .life-box.temp { background: #ffeb3b; border-color: #ccaa00; box-shadow: 0 0 5px #ffeb3b; }

        /* --- ä¸­å¤®ãƒ‘ãƒãƒ«ï¼šãƒã‚¤ãƒ³ãƒˆãƒ»ã‚²ãƒ¼ãƒ ç”»é¢ãƒ»æŒã¡å¸°ã‚‹ --- */
        .point-hud { background: #151515; border: 1px solid #333; padding: 15px; border-radius: 12px; width: 100%; text-align: center; box-sizing: border-box; margin-bottom: 15px; min-height: 140px; display: flex; flex-direction: column; justify-content: flex-start; }
        .pts-val { font-size: 32px; color: #ffeb3b; font-weight: bold; margin: 5px 0; word-break: break-all; }
        .pending-box { margin-top: 10px; border-top: 1px solid #333; padding-top: 10px; visibility: hidden; }

        #fever-container { width: 90%; height: 12px; min-height: 12px; flex-shrink: 0; background: #222; border-radius: 6px; overflow: hidden; border: 2px solid #444; visibility: hidden; margin-bottom: 10px; }
        #fever-bar { width: 0%; height: 100%; background: linear-gradient(90deg, #ffeb3b, #ff5500); box-shadow: 0 0 15px #ffeb3b; }

        #score-display { font-size: 70px; font-weight: 900; color: #ff0055; margin: 0 0 10px 0; line-height: 1; text-shadow: 0 0 20px rgba(255, 0, 85, 0.4); }

        .game-area { position: relative; display: flex; justify-content: center; align-items: center; margin-bottom: 15px; }
        canvas { 
            background: #000; border-radius: 50%; border: 4px solid #333; cursor: pointer; position: relative; z-index: 2; transition: border-color 0.2s, box-shadow 0.2s; 
            -webkit-touch-callout: none; /* ã‚¹ãƒãƒ›é•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç¦æ­¢ */
            -webkit-tap-highlight-color: transparent; /* ã‚¿ãƒƒãƒ—æ™‚ã®é’æ ã‚’æ¶ˆå» */
        }
        
        #click-here-msg {
            position: absolute; top: -35px; left: 50%; transform: translateX(-50%);
            font-size: 20px; color: #ffeb3b; font-weight: bold; z-index: 20;
            text-shadow: 0 0 10px #ffeb3b, 0 0 2px #000;
            pointer-events: none; display: none; transition: 0.2s; white-space: nowrap;
        }

        .fever-active { border-color: #ffeb3b !important; box-shadow: 0 0 30px #ffeb3b !important; animation: shake 0.1s infinite; }
        .slow-active { border-color: #00ffff !important; box-shadow: 0 0 30px #00ffff !important; }
        .boss-active { border-color: #ff0055 !important; box-shadow: 0 0 30px #ff0055 !important; }
        @keyframes shake { 0% { transform: translate(1px, 1px); } 50% { transform: translate(-1px, -1px); } 100% { transform: translate(0,0); } }

        #pause-btn { position: absolute; top: -30px; right: 10px; font-size: 24px; cursor: pointer; color: #555; transition: 0.2s; z-index: 10; }
        #pause-btn:hover { color: #fff; }

        #bomb-gif { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 280px; z-index: 100; pointer-events: none; display: none; }
        
        #overlay-msg { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; display:none; background: rgba(0,0,0,0.8); z-index: 10; align-items: center; justify-content: center; flex-direction: column; border-radius: 50%; }
        
        .roll-text { 
            text-align: center; color: white; font-weight: bold; display: none; font-size: 22px; 
            background: linear-gradient(90deg, #ffeb3b, #ff0055, #00ffcc, #ffeb3b);
            background-size: 200% auto;
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
            animation: scrollUp 15s linear forwards, shine 3s linear infinite;
        }
        @keyframes shine { to { background-position: 200% center; } }
        
        .pause-text { font-size: 30px; letter-spacing: 5px; color: #00ffcc; text-shadow: 0 0 10px #00ffcc; display: none; }
        @keyframes scrollUp { 0% {top:100%;} 100% { top: -40%; } }

        .withdraw-row { display: flex; width: 100%; gap: 10px; visibility: hidden; align-items: center; min-height: 52px; }
        #btn-withdraw { flex: 1; background: linear-gradient(135deg, #ff5500, #cc2200); padding: 15px; font-size: 18px; }
        #tikuwa-img { width: 50px; height: 50px; object-fit: contain; display: none; cursor: pointer; }

        .floating-text { position: absolute; pointer-events: none; font-weight: bold; font-size: 24px; text-shadow: 0 0 5px #000, 0 0 10px rgba(0,0,0,0.8); z-index: 50; animation: floatUp 1s ease-out forwards; }
        @keyframes floatUp { 0% { transform: translateY(0) scale(0.8); opacity: 1; } 10% { transform: translateY(-10px) scale(1.2); opacity: 1; } 100% { transform: translateY(-60px) scale(1); opacity: 0; } }

        /* --- å³ãƒ‘ãƒãƒ«ï¼šã‚¢ã‚¤ãƒ†ãƒ ãƒ»ãƒ¡ãƒ‹ãƒ¥ãƒ¼ --- */
        .consume-area { 
            background: #1a1a1a; border: 1px dashed #444; border-radius: 8px; padding: 10px; 
            width: 100%; box-sizing: border-box; display: none; 
            max-height: 400px; display: flex; flex-direction: column; margin-bottom: auto; 
        }
        .consume-title { font-size: 12px; color: #aaa; margin-bottom: 8px; text-align: center; flex-shrink: 0; }
        .consume-list { display: flex; flex-direction: column; gap: 8px; overflow-y: auto; flex-grow: 1; padding-right: 5px; }
        
        .consume-item-btn { background: #2a2a2a; border: 1px solid #555; color: #fff; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; text-align: left; }
        .consume-item-btn:hover { background: #333; }
        .consume-item-btn:disabled { cursor: not-allowed; opacity: 0.8; }
        .consume-item-btn.active-buff { box-shadow: 0 0 10px #00ffcc; border-color: #00ffcc; }
        .consume-item-btn.active-buff-unique { box-shadow: 0 0 10px #0077ff; border-color: #0077ff; }

        .item-icon-box {
            width: 32px; height: 32px; flex-shrink: 0; background: rgba(255, 255, 255, 0.05); border-radius: 6px; 
            display: flex; align-items: center; justify-content: center; overflow: hidden; margin-right: 10px;
        }
        .item-icon-box img { width: 100%; height: 100%; object-fit: contain; }

        #gadget-sidebar { display: flex; flex-direction: row; gap: 10px; justify-content: center; width: 100%; margin-bottom: 10px; }
        .gadget-btn { width: 50px; height: 50px; background: #222; border: 2px solid #555; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; cursor: pointer; display: none; }

        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; }
        .game-btn { background: #333; border: none; color: white; border-radius: 8px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; box-shadow: 0 4px 0 #111; transition: 0.1s; }
        .game-btn:active { transform: translateY(4px); box-shadow: none; }
        
        .btn-upgrade { background: linear-gradient(to bottom, #0077ff, #0055aa); grid-column: 1 / -1; padding: 15px; font-size: 16px; }
        .btn-shop { background: linear-gradient(to bottom, #9900ff, #6600cc); grid-column: 1 / -1; padding: 15px; font-size: 16px; }
        .side-btns { display: flex; gap: 10px; grid-column: 1 / -1; }
        .btn-small { background: #444; flex:1; padding: 6px; flex-direction: column; font-size: 20px; } 

        /* --- ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€š --- */
        .modal {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(15, 15, 15, 0.98); border: 2px solid #555; padding: 20px;
            border-radius: 12px; width: 90%; max-width: 440px; z-index: 100; max-height: 85vh; overflow-y: auto;
            box-shadow: 0 0 30px rgba(0,0,0,0.8); -webkit-overflow-scrolling: touch; 
        }
        
        /* å¼·åŒ–ãƒ©ãƒœãƒ»ã‚·ãƒ§ãƒƒãƒ—ã¯åºƒãã€‚ */
        #modal-upgrade, #modal-shop { max-width: 720px; padding: 0; overflow: hidden; flex-direction: column; }

        /* ã‚ã‹ã‚Šã‚„ã™ã„ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼è¨­å®šï¼ˆæ°´è‰²ï¼‰ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111; border-radius: 4px; border: 1px solid #222; }
        ::-webkit-scrollbar-thumb { background: #00ffcc; border-radius: 4px; box-shadow: inset 0 0 2px rgba(0,0,0,0.5); }
        ::-webkit-scrollbar-thumb:hover { background: #00ccaa; }

        /* --- ãƒ¢ãƒ¼ãƒ€ãƒ«é–“ã®ã‚¿ãƒ–ç§»å‹• --- */
        .modal-nav-tabs {
            display: flex; gap: 2px; background: #0a0a0a; border-bottom: 2px solid #333; flex-shrink: 0;
        }
        .modal-nav-btn {
            flex: 1; padding: 15px; background: #1a1a1a; color: #888; border: none; 
            cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.2s;
        }
        .modal-nav-btn.active {
            background: rgba(15, 15, 15, 0.98); color: #fff; border-bottom: 3px solid #00ffcc;
        }
        .modal-nav-btn:not(.active):hover {
            background: #222; color: #fff;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ä¸Šéƒ¨å›ºå®š */
        .modal-header { 
            display: flex; flex-direction: column; align-items: stretch; gap: 10px;
            border-bottom: 1px solid #333; position: sticky; top: 0; z-index: 20;
            background: rgba(15, 15, 15, 0.98); padding: 15px 25px 12px 25px;
            backdrop-filter: blur(4px); flex-shrink: 0;
        }
        .modal-header-top { display: flex; justify-content: space-between; align-items: baseline; }
        .close { font-size: 24px; background: #333; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; margin-top: -5px; }

        /* å†…éƒ¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ */
        .modal-scroll-area {
            padding: 0 25px 20px 25px; overflow-y: auto; flex-grow: 1;
        }

        /* ã‚¿ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆã‚·ãƒ§ãƒƒãƒ—ç”¨ï¼‰ */
        .shop-tabs { display: flex; gap: 5px; margin-bottom: 15px; }
        .shop-tab-btn { flex: 1; padding: 10px; background: #222; color: #888; border: 1px solid #444; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .shop-tab-btn.active { background: #00ffcc; color: #000; border-color: #00ffcc; }

        /* --- æ–°ãƒ‡ã‚¶ã‚¤ãƒ³ï¼š2ã‚«ãƒ©ãƒ ã‚°ãƒªãƒƒãƒ‰ï¼ˆå¼·åŒ–ãƒ»ã‚·ãƒ§ãƒƒãƒ—å…±é€šï¼‰ --- */
        #list-upgrade, #list-shop {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            padding-bottom: 10px;
        }

        /* ã‚¹ãƒãƒ¼ãƒˆãªã‚«ãƒ†ã‚´ãƒªè¦‹å‡ºã—  */
        .skill-category-title { 
            grid-column: 1 / -1;
            font-size: 14px; font-weight: bold; margin: 15px 0 0 0; 
            padding: 6px 10px; background: linear-gradient(90deg, rgba(255,255,255,0.08), transparent);
            border-left: 4px solid; color: #fff; text-shadow: 0 0 5px rgba(0,0,0,0.5); border-radius: 4px;
        }
        .skill-category-title:first-child { margin-top: 5px; }

        .lock-badge {
            display: inline-block; background: #331111; color: #ff5555; font-size: 11px;
            padding: 2px 6px; border-radius: 4px; border: 1px solid #ff0055; font-weight: bold;
        }

        /* ã‚«ãƒ¼ãƒ‰å‹ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ  */
        .list-row { 
            background: #1a1a1a; padding: 12px;
            border-radius: 8px; border: 1px solid #333; display: flex; flex-direction: column;
            justify-content: space-between; transition: background 0.2s, transform 0.1s; 
            margin-bottom: 0; 
        }
        .list-row:hover { background: #222; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        
        .list-row-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .list-title { display: flex; align-items: center; gap: 10px; font-weight: bold; font-size: 14px; color: #fff; }
        .list-title-wrapper { display: flex; flex-direction: column; gap: 2px; }
        
        /* å¼·åŒ–èª¬æ˜æ–‡ã‚¨ãƒªã‚¢ */
        .list-desc-wrapper {
            background: rgba(0, 0, 0, 0.4); border-radius: 6px; 
            padding: 8px; margin-bottom: 12px; border: 1px solid #2a2a2a; flex-grow: 1;
        }
        .list-desc { font-size: 12px; color: #ddd; white-space: pre-wrap; line-height: 1.5; }
        /* ãƒ•ãƒ¬ãƒ¼ãƒãƒ¼ãƒ†ã‚­ã‚¹ãƒˆ */
        .list-flavor { font-size: 10px; color: #777; font-style: italic; margin-top: 6px; padding-top: 6px; border-top: 1px dashed #333; line-height: 1.3;}
        
        .list-bottom { display: flex; justify-content: space-between; align-items: flex-end; }

        /* ã‚¢ã‚¤ã‚³ãƒ³æ ã¨åŠ¹æœé‡è¡¨ç¤ºæ  */
        .skill-icon-box {
            width: 32px; height: 32px; flex-shrink: 0; background: rgba(255, 255, 255, 0.08); 
            border-radius: 6px; display: flex; align-items: center; justify-content: center; 
            font-size: 18px; border: 1px solid #444; overflow: hidden;
        }
        .skill-icon-box img { width: 100%; height: 100%; object-fit: contain; }

        .list-effect-box {
            font-size: 11px; font-weight: bold; color: #00ffcc; 
            background: rgba(0, 255, 204, 0.1); padding: 6px 10px; 
            border-radius: 4px; margin-bottom: 12px; border: 1px dashed rgba(0,255,204,0.3);
        }
        .list-effect-box.secret {
            color: #777; background: rgba(255,255,255,0.05); border-color: #444;
        }

        .list-btn { 
            background: #00ffcc; color: #000; border: none; padding: 8px 16px; 
            border-radius: 4px; font-weight: bold; font-size: 12px; cursor: pointer; min-width: 60px; 
        }
        .list-btn:disabled { background: #444; color: #777; cursor: default; }
        .toggle-btn { background: #444; color: #fff; border: none; padding: 6px 10px; border-radius: 4px; font-size: 11px; cursor: pointer; }
        .toggle-btn.on { background: #ffeb3b; color: #000; }

        /* --- ã‚¹ãƒãƒ›å°‚ç”¨ã®è¦ç´  --- */
        .mobile-only { display: none !important; }
        #mobile-top-bar { display: none; }

        .mobile-btn {
            transition: transform 0.1s;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        .mobile-btn:active {
            transform: translateY(4px);
            box-shadow: none !important;
        }

        /* --- âœ¨ã‚¹ãƒãƒ›å‘ã‘å¤§å¹…ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆï¼ˆè¦‹ã‚„ã™ã•ãƒ»æ“ä½œæ€§å‘ä¸Šï¼‰âœ¨ --- */
        @media (max-width: 900px) {
            /* ä½™ç™½ã®èª¿æ•´ */
            .layout-container { padding: 0 10px 160px 10px; gap: 15px; flex-direction: column; }
            .left-panel, .center-panel, .right-panel { width: 100%; max-width: 100%; padding: 0; justify-content: flex-start; }
            
            /* è¡¨ç¤ºé †ã®å¤‰æ›´ï¼ˆ1.ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ â†’ 2.ã‚²ãƒ¼ãƒ ç”»é¢ â†’ 3.ã‚¢ã‚¤ãƒ†ãƒ ï¼‰ */
            .left-panel { order: 1; }
            .center-panel { order: 2; }
            .right-panel { order: 3; }

            /* â˜… ã‚¹ãƒãƒ›å°‚ç”¨ã®å›ºå®šãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆãƒ©ã‚¤ãƒ•ã¨ã‚¹ã‚³ã‚¢ã‚’ç”»é¢ä¸Šéƒ¨ã«è¿½å¾“ã•ã›ã‚‹ï¼‰ */
            #mobile-top-bar {
                display: flex !important;
                position: sticky; top: 0; z-index: 100;
                background: rgba(15, 15, 15, 0.95);
                border-bottom: 2px solid #333;
                padding: 10px 15px;
                padding-top: max(10px, env(safe-area-inset-top)); /* ã‚¹ãƒãƒ›ã®ãƒãƒƒãƒå¯¾ç­– */
                justify-content: space-between;
                align-items: center;
                backdrop-filter: blur(5px);
                margin: 0 -10px 15px -10px;
                box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            }
            .mobile-top-item { display: flex; flex-direction: column; align-items: center; justify-content: center; }

            /* PCç”¨ã®è¦ç´ ã‚’ã‚¹ãƒãƒ›ã§ã¯éš ã™ï¼ˆé‡è¤‡ã‚’é˜²ããŸã‚ï¼‰ */
            .stats-box .stat-line:first-child { display: none; } /* ãƒ©ã‚¤ãƒ• */
            #score-display { display: none; } /* ã‚¹ã‚³ã‚¢ */
            .pending-box { display: none; } /* ä¸€æ™‚ç²å¾—ãƒã‚¤ãƒ³ãƒˆ */
            .stats-box hr { display: none; }

            .stats-box { display: flex; flex-direction: row; flex-wrap: wrap; justify-content: space-between; padding: 10px 15px; gap: 10px; }
            .stat-line { margin: 0; font-size: 14px; }
            
            .point-hud { min-height: auto; padding: 10px; flex-direction: row; flex-wrap: wrap; justify-content: space-around; align-items: center; margin-bottom: 0;}
            .pts-val { font-size: 24px; margin: 0; }

            .record-box { display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; justify-content: space-around; }
            .record-line { margin-top: 0; font-size: 12px; }

            /* â˜… TAPãƒœã‚¿ãƒ³ã®å°å‹åŒ–ï¼ˆæŠ¼ã—é–“é•ãˆé˜²æ­¢ã®ãƒ”ãƒ«å‹ãƒ‡ã‚¶ã‚¤ãƒ³ï¼‰ */
            #mobile-tap-btn {
                flex: none !important;
                width: 200px; /* æ¨ªå¹…ã‚’åˆ¶é™ */
                height: 60px; /* é«˜ã•ã‚’ã‚¹ãƒªãƒ ã« */
                border-radius: 30px !important; /* ä¸¸ã¿ã‚’å¸¯ã³ãŸãƒ‡ã‚¶ã‚¤ãƒ³ */
                margin: 0 auto;
                font-size: 20px !important;
                letter-spacing: 2px;
            }

            /* å¼·åŒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ»è¨­å®šãªã©ã‚’ç”»é¢ã®ä¸€ç•ªä¸‹ã«å›ºå®šé…ç½®ï¼ˆã‚¢ãƒ—ãƒªé¢¨UIï¼‰ */
            .menu-grid { 
                position: fixed; bottom: 0; left: 0; width: 100%; 
                background: rgba(15, 15, 15, 0.98); 
                border-top: 2px solid #00ffcc; 
                padding: 10px; box-sizing: border-box; 
                z-index: 1000; 
                display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
                box-shadow: 0 -5px 15px rgba(0,0,0,0.8);
                padding-bottom: env(safe-area-inset-bottom, 10px); /* iPhoneã®ãƒãƒ¼å¯¾ç­– */
            }
            .btn-upgrade, .btn-shop { grid-column: span 1; padding: 12px; font-size: 16px; border-radius: 8px; }
            .side-btns { grid-column: 1 / -1; display: flex; gap: 8px; }
            .btn-small { flex: 1; padding: 8px; font-size: 16px; flex-direction: row; justify-content: center; align-items: center; }
            .btn-small span { margin-top: 0; margin-left: 6px; font-size: 12px; }

            /* ã‚¹ãƒãƒ›å°‚ç”¨ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒ†ãƒŠè¡¨ç¤º */
            .mobile-only.control-row { display: flex !important; gap: 10px; margin-bottom: 15px; width: 100%; justify-content: center; }

            /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®èª¿æ•´ */
            .modal { padding: 15px; width: 95%; max-width: none; max-height: 85vh; }
            #list-upgrade, #list-shop { grid-template-columns: 1fr; }
            #modal-upgrade, #modal-shop { padding: 0; }
            .modal-header { padding: 15px; }
            .modal-scroll-area { padding: 0 15px 20px 15px; }
        }
    </style>
</head>
<body>

<div id="title-screen">
    <h1 id="title-name">ã‚¯ãƒ­ãƒƒã‚¯ ã‚¹ãƒˆãƒƒãƒ‘ãƒ¼</h1>
    <p id="title-sub">ULTIMATE VIP EDITION</p>
    <button id="btn-start">GAME START</button>
</div>

<div id="modal-start-help" class="modal" style="padding: 20px;">
    <div class="modal-header-top" style="margin-bottom:10px;"><h3 style="margin:0;">ç°¡æ˜“ãƒãƒ‹ãƒ¥ã‚¢ãƒ«</h3></div>
    <div style="font-size:14px; line-height:1.6; color:#ccc; margin-bottom:20px;">
        <p>ãƒ»å›è»¢ã™ã‚‹é‡ãŒ<strong>èµ¤ã„ã‚¨ãƒªã‚¢</strong>ã«æ¥ãŸã‚‰<span style="color:#00ffcc;">ç”»é¢ã‚’ã‚¿ãƒƒãƒ—</span>ã¾ãŸã¯<span style="color:#00ffcc;">ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼</span>ï¼</p>
        <p>ãƒ»å·¦ä¸‹ã®ãƒ©ã‚¤ãƒ•ãŒãªããªã‚‹ã¨<span style="color:#00ffcc;">ãƒã‚¤ãƒ³ãƒˆãŒä¸€éƒ¨å¤±ã‚ã‚Œã‚‹ï¼</span>ãƒ©ã‚¤ãƒ•ãŒãªããªã‚‹å‰ã«<span style="color:#efb627;">ãƒã‚¤ãƒ³ãƒˆæŒã¡å¸°ã‚Š</span>ã‚’æŠ¼ã—ã€ãƒã‚¤ãƒ³ãƒˆã‚’ä¿æŒã—ã‚ˆã†ï¼</p>
        <p>ãƒ»ãƒã‚¤ãƒ³ãƒˆãŒæºœã¾ã£ãŸã‚‰å³å´ã®<span style="color:#00ffcc;">ã€Œå¼·åŒ–ãƒ©ãƒœã€</span>ã§ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã‚„<span style="color:#00ffcc;">ã€Œã‚·ãƒ§ãƒƒãƒ—ã€</span>ã§è¦‹ãŸç›®ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãŒã§ãã‚‹ãï¼</p>
        <p>ãƒ»ç›®æŒ‡ã›<strong><span style="color:#00ffcc;">100ã‚¹ã‚³ã‚¢</strong></span>ï¼</p>
    </div>
    <button id="btn-close-start-help" style="width:100%; padding:15px; background:linear-gradient(135deg, #00ffcc, #0088aa); color:black; font-size:18px; font-weight:bold; border:none; border-radius:8px; cursor:pointer;">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
</div>

<div id="modal-tutorial" class="modal" style="padding: 20px; text-align:center; border: 2px solid #00ffcc; z-index: 200;">
    <h3 id="tut-title" style="margin-top:0; margin-bottom:15px; color:#00ffcc; font-size:20px;">ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«</h3>
    <p id="tut-desc" style="font-size:15px; color:#ddd; line-height:1.6; margin-bottom:25px;"></p>
    <button onclick="closeTutorial()" style="width:100%; padding:15px; background:linear-gradient(135deg, #00ffcc, #0088aa); color:black; font-size:18px; font-weight:bold; border:none; border-radius:8px; cursor:pointer;">ã‚ã‹ã£ãŸï¼</button>
</div>

<div class="layout-container" id="main-ui">

    <div id="mobile-top-bar" class="mobile-only">
        <div class="mobile-top-item" style="align-items:flex-start;">
            <span style="font-size:11px;color:#aaa;font-weight:bold;">LIFE</span>
            <div class="life-container" id="mobile-val-life" style="justify-content:flex-start;"></div>
        </div>
        <div class="mobile-top-item">
            <span style="font-size:11px;color:#aaa;font-weight:bold;letter-spacing:2px;">SCORE</span>
            <div id="mobile-score-display" style="font-size:32px; font-weight:900; color:#ff0055; line-height:1; text-shadow:0 0 10px rgba(255,0,85,0.5);">0</div>
        </div>
        <div class="mobile-top-item" style="align-items:flex-end;">
            <span style="font-size:11px;color:#aaa;font-weight:bold;">PENDING</span>
            <div id="mobile-pending-display" style="font-size:22px; font-weight:bold; color:#ff5500;">0</div>
        </div>
    </div>

    <div class="panel left-panel">
        <div class="record-box">
            <div style="font-size:12px; color:#888; text-align:center; margin-bottom:5px;">- RECORDS -</div>
            <div class="record-line">æœ€é«˜ã‚¹ã‚³ã‚¢: <span id="rec-score">0</span></div>
            <div class="record-line">æœ€å¤§ã‚³ãƒ³ãƒœ: <span id="rec-combo">0</span></div>
        </div>

        <div id="clock-sidebar"></div>

        <div class="stats-box">
            <div class="stat-line">
                <span>LIFE<span style="color:#ec1a1a;"> â¤</span></span>
                <div class="life-container" id="val-life"></div>
            </div>
            <hr style="border:0; border-top:1px dashed #333; margin:8px 0;">
            <div class="stat-line"><span>SPEEDâš¡</span><span style="color:#fff;">x<span id="val-spd">1.0</span></span></div>
            <div class="stat-line" id="slow-wrapper"><span>SLOW<span style="color:#52d5e1;">â±</span></span><span style="color:#fff;"><span id="val-slow">0</span> å› <span id="val-slow-timer" style="color:#00ffff;"></span></span></div>
            <div class="stat-line" id="shield-wrapper" style="display:none;"><span>SHIELD</span><span style="color:#ffd700;">ğŸ›¡ï¸ <span id="val-shield">0</span></span></div>
        </div>
    </div>

    <div class="panel center-panel">
        <div id="fever-container"><div id="fever-bar"></div></div>
        <div id="score-display">0</div>
        
        <div class="game-area">
            <div id="click-here-msg">CLICK HERE! â†“</div>
            <div id="pause-btn">â¸ï¸</div>
            <canvas id="canvas" width="280" height="280"></canvas>
            <img id="bomb-gif" src="bakuhatu.gif" alt=""> 
            <img id="needle-img" src="needle.png" style="display:none;" crossorigin="anonymous">
            
            <div id="overlay-msg">
                <div class="roll-text" id="ending-txt" style="position: absolute; width: 100%;">
                    ãŠã‚ã§ã¨ã†!<br><br>ã‚ãªãŸã¯ã“ã®ã‚²ãƒ¼ãƒ ã‚’ã‚ˆãéŠã‚“ã§ãã‚Œã¾ã—ãŸ<br><br>THANK YOU FOR PLAYING!<br><br><br><br>æ–°ãŸãªæ‰‰ãŒé–‹ã‹ã‚ŒãŸã‚ˆã†ã â€¦
                </div>
                <div class="pause-text" id="pause-txt">PAUSED</div>
            </div>
        </div>

        <div style="font-size: 12px; color: #777; text-align: center; margin-bottom: 10px; font-weight: bold; letter-spacing: 1px; user-select: none;">
            [ã‚¯ãƒªãƒƒã‚¯ / Space] ã‚¹ãƒˆãƒƒãƒ— <span id="guide-slow" style="display: none;">&nbsp;&nbsp; [S] ã‚¹ãƒ­ãƒ¼</span> &nbsp;&nbsp; [Esc] ãƒãƒ¼ã‚º
        </div>

        <div id="mobile-controls" class="mobile-only control-row">
            <button id="mobile-slow-btn" class="mobile-btn" style="padding: 15px; font-size: 16px; font-weight: bold; background: linear-gradient(135deg, #00ffff, #0088aa); border: none; border-radius: 12px; box-shadow: 0 4px 0 #005577; cursor: pointer; color: #000; display: none;">â±ï¸ SLOW</button>
            <button id="mobile-tap-btn" class="mobile-btn" style="background: linear-gradient(135deg, #00ffcc, #0088aa); border: none; box-shadow: 0 4px 0 #005577; cursor: pointer; color: #000;">ğŸ‘† TAP ğŸ‘†</button>
        </div>

        <div class="withdraw-row" id="row-withdraw">
            <button id="btn-withdraw" class="game-btn">ğŸ’° ãƒã‚¤ãƒ³ãƒˆæŒã¡å¸°ã‚Š</button>
            <img id="tikuwa-img" src="tikuwa.png" alt="ğŸ¢">
        </div>
        <div class="point-hud">
            <div style="font-size:12px; color:#888;">TOTAL POINTS</div>
            <div class="pts-val" id="ui-pts">0</div>
            <div id="pending-box" class="pending-box">
                <div style="font-size:12px; color:#ff5500;">ä¸€æ™‚ç²å¾—åˆ†</div>
                <div style="font-size:22px; font-weight:bold; color:#ff5500;" id="ui-pending">0</div>
                <div style="font-size:11px; color:#5fb1d4; margin-top:3px;">æœ€ä½ä¿è¨¼: <span id="ui-ins">0</span></div>
            </div>
        </div>
    </div>

    <div class="panel right-panel">
        <div id="consume-area" class="consume-area">
            <div class="consume-title">- INVENTORY -</div>
            <div class="consume-list" id="consume-list"></div>
        </div>

        <div id="gadget-sidebar">
            <div id="gd-btn" class="gadget-btn">ğŸ”´</div>
            <div id="gd-metro" class="gadget-btn">â±ï¸</div>
            <div id="gd-bomb" class="gadget-btn">ğŸ’£</div>
            <div id="gd-neko" class="gadget-btn" style="transition: transform 0.2s;">ğŸ±</div>
        </div>

        <div class="menu-grid">
            <button id="btn-upgrade" class="game-btn btn-upgrade">ğŸ”§ å¼·åŒ–ãƒ©ãƒœ</button>
            <button id="btn-shop" class="game-btn btn-shop">ğŸ ã‚·ãƒ§ãƒƒãƒ—</button>
            <div class="side-btns">
                <button id="btn-sys" class="game-btn btn-small" title="è¨­å®š">âš™ï¸<span style="font-size:10px; margin-top:2px;">è¨­å®š</span></button>
                <button id="btn-status" class="game-btn btn-small" title="ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹">ğŸ“Š<span style="font-size:10px; margin-top:2px;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</span></button>
                <button id="btn-help" class="game-btn btn-small" title="ãƒ˜ãƒ«ãƒ—">â“<span style="font-size:10px; margin-top:2px;">ãƒ˜ãƒ«ãƒ—</span></button>
            </div>
        </div>
    </div>
</div>

<div id="modal-upgrade" class="modal">
    <div class="modal-nav-tabs">
        <button class="modal-nav-btn active">ğŸ”§ å¼·åŒ–ãƒ©ãƒœ</button>
        <button class="modal-nav-btn" onclick="openModal('modal-shop')">ğŸ ã‚·ãƒ§ãƒƒãƒ—</button>
    </div>
    <div class="modal-header">
        <div class="modal-header-top">
            <div style="display:flex; align-items:baseline; gap:12px; flex-wrap: wrap;">
                <h3 style="margin:0;">å¼·åŒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h3>
                <span style="font-size:13px; color:#00ffcc; font-weight:bold;">åˆè¨ˆLv: <span id="modal-total-lv">0</span></span>
                <span style="font-size:13px; color:#ffeb3b; font-weight:bold;">æ‰€æŒ: <span class="modal-pts-display">0</span> Pt</span>
            </div>
            <span class="close" onclick="closeAllModals()">Ã—</span>
        </div>
    </div>
    <div class="modal-scroll-area">
        <div id="list-upgrade" style="min-height: 200px; margin-top: 5px;"></div>
    </div>
</div>

<div id="modal-shop" class="modal">
    <div class="modal-nav-tabs">
        <button class="modal-nav-btn" onclick="openModal('modal-upgrade')">ğŸ”§ å¼·åŒ–ãƒ©ãƒœ</button>
        <button class="modal-nav-btn active">ğŸ ã‚·ãƒ§ãƒƒãƒ—</button>
    </div>
    <div class="modal-header">
        <div class="modal-header-top">
            <div style="display:flex; align-items:baseline; gap:15px;">
                <h3 style="margin:0;">ã‚¢ã‚¤ãƒ†ãƒ è³¼å…¥</h3>
                <span style="font-size:14px; color:#ffeb3b; font-weight:bold;">æ‰€æŒ: <span class="modal-pts-display">0</span> Pt</span>
            </div>
            <span class="close" onclick="closeAllModals()">Ã—</span>
        </div>
        <div class="shop-tabs" id="shop-tabs" style="display:none; margin-top:10px; margin-bottom:5px;">
            <button class="shop-tab-btn active" id="tab-skin" onclick="changeShopTab('skin')">ã‚¹ã‚­ãƒ³ãƒ»æ–½è¨­</button>
            <button class="shop-tab-btn" id="tab-item" onclick="changeShopTab('item')">æ¶ˆè²»ã‚¢ã‚¤ãƒ†ãƒ </button>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:flex-end;">
            <div id="skin-caution" style="font-size:11px; color:#ff5555; font-weight:bold; display:none;">â€»è³¼å…¥å¾Œã¯ã€Œè£…å‚™ã€ã—ãªã„ã¨æ„å‘³ãŒãªã„ãœï¼</div>
            <button id="btn-reset-looks" onclick="resetLooks()" style="font-size:11px; padding:4px 8px; margin-left:auto;">è¦‹ãŸç›®ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
    </div>
    <div class="modal-scroll-area">
        <div id="list-shop"></div>
    </div>
</div>

<div id="modal-help" class="modal" style="padding: 20px;">
    <div class="modal-header-top" style="margin-bottom:10px;"><h3 style="margin:0;">éŠã³æ–¹</h3><span class="close" onclick="closeAllModals()">Ã—</span></div>
    <div style="font-size:14px; line-height:1.6; color:#ccc; margin-top:10px;">
        <p><strong>â–  åŸºæœ¬ãƒ«ãƒ¼ãƒ«</strong><br>å›è»¢ã™ã‚‹é‡ãŒèµ¤ã„ã‚¨ãƒªã‚¢ã«æ¥ãŸã‚‰ã‚¯ãƒªãƒƒã‚¯ï¼ˆã¾ãŸã¯ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ï¼‰ã™ã‚‹ã¨ã‚¹ã‚³ã‚¢ã¨ãƒã‚¤ãƒ³ãƒˆãŒãŸã¾ã‚‹ï¼ç›®æŒ‡ã›100ã‚¹ã‚³ã‚¢ï¼<br>Escã‚­ãƒ¼ã¾ãŸã¯ç”»é¢ä¸­å¤®å³ä¸Šã®ã‚¢ã‚¤ã‚³ãƒ³ã§ãƒãƒ¼ã‚ºã€‚</p>
        <p><strong>â–  æŒã¡å¸°ã‚‹</strong><br>ãƒã‚¤ãƒ³ãƒˆã¯ãƒ©ã‚¤ãƒ•ãŒï¼ã«ãªã‚‹ã¨æœ€ä½ä¿è¨¼ã®åˆ†ã—ã‹æŒã£ã¦å¸°ã‚Œã¾ã›ã‚“ã€‚ãƒŸã‚¹ã™ã‚‹å‰ã«æŠ¼ã™ã“ã¨ã§ãƒã‚¤ãƒ³ãƒˆã‚’å…¨ã¦æŒã¡å¸°ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
        <p><strong>â–  å¼·åŒ–ãƒ©ãƒœ</strong><br>ãŸã¾ã£ãŸãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ã£ã¦ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚<br>å¼·åŒ–ã—ãŸæ©Ÿèƒ½ã¯OFFã«ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™</p>
        <p><strong>â–  ã‚·ãƒ§ãƒƒãƒ—</strong><br>ãŸã¾ã£ãŸãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ã„ã‚¹ã‚­ãƒ³ã‚„æ–½è¨­ã‚’è²·ã†äº‹ãŒã§ãã¾ã™ã€‚ãŠã—ã‚ƒã‚Œã—ã¦ã„ã‚‹ä¸­ã«ã‚‚å½¹ç«‹ã¤ã‚‚ã®ã‚‚ã‚ã‚‹ã‹ã‚‚â€¦ï¼Ÿ</p>
        <p><strong>â–  ãƒœã‚¹æˆ¦</strong><br>10å›ã”ã¨ã«å‹•ãçš„ãŒå‡ºç¾ï¼é›£æ˜“åº¦ã¯é«˜ã„ãŒãƒã‚¤ãƒ³ãƒˆã‚‚å¤šãã‚‚ã‚‰ãˆã‚‹ãï¼</p>
        <p><strong>â–  ã‚¹ãƒ­ãƒ¼æ©Ÿèƒ½</strong><br>å¼·åŒ–å¾Œã§é–‹æ”¾ã™ã‚‹ã¨ã€<strong>Sã‚­ãƒ¼</strong>ã¾ãŸã¯<strong>ã‚¹ãƒ­ãƒ¼ãƒœã‚¿ãƒ³</strong>ã‚’æŠ¼ã™ã“ã¨ã§ä¸€å®šæ™‚é–“ã‚¹ãƒ­ãƒ¼ã«ãªã‚Šã¾ã™ï¼ˆå›æ•°æ¶ˆè²»ï¼‰ã€‚</p>
        <p><strong>â–  ãƒ•ã‚£ãƒ¼ãƒãƒ¼</strong><br>å¼·åŒ–å¾Œã§é–‹æ”¾ã™ã‚‹ã¨ã€ã‚²ãƒ¼ã‚¸æº€ã‚¿ãƒ³ã§çªå…¥ã€‚æ™‚é–“å†…ã‚¯ãƒªãƒƒã‚¯ã—æ”¾é¡Œã«ãªã‚Šã¾ã™ï¼ãªãŠã‚²ãƒ¼ã‚¸ã¯ãƒŸã‚¹ã™ã‚‹ã¨10%å¾Œé€€ã—ã¦ã—ã¾ã„ã¾ã™ã€‚</p>
        <p><strong>â–  é›£æ˜“åº¦ã®ä¸Šæ˜‡</strong><br>ã‚¹ã‚³ã‚¢50ä»¥é™ã¯é‡ãŒé€†å›è»¢ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚<br>ã‚¹ã‚³ã‚¢75ä»¥é™ã¯æˆåŠŸåˆ¤å®šã®æ¨ªã«ã€è§¦ã‚Œã‚‹ã¨å³æ­»ã™ã‚‹é’ã„ğŸ’€ã‚¨ãƒªã‚¢ãŒå‡ºç¾ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚</p>
    </div>
</div>

<div id="modal-sys" class="modal" style="padding: 20px;">
    <div class="modal-header-top" style="margin-bottom:10px;"><h3 style="margin:0;">è¨­å®š</h3><span class="close" onclick="closeAllModals()">Ã—</span></div>
    <div style="font-size:14px; margin-top:10px;">
        <label>SEéŸ³é‡</label><input type="range" id="vol-se" min="0" max="1" step="0.1" value="0.5" style="width:100%; margin-bottom: 10px;">
        <label>ãƒ•ã‚£ãƒ¼ãƒãƒ¼ã®å½©åº¦ (%)</label><input type="range" id="vol-sat" min="0" max="100" step="1" value="100" style="width:100%; margin-bottom: 10px;">
        
        <div style="display:flex; justify-content:space-between; align-items:center; background:#222; padding:10px; border-radius:6px;">
            <span>ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—æ•°å­—è¡¨ç¤º</span>
            <button id="toggle-num-btn" onclick="toggleNumbers()" class="toggle-btn on">ON</button>
        </div>

        <hr style="border:0; border-top:1px solid #333; margin:20px 0;">
        <p style="font-size:12px; color:#aaa; margin-bottom:5px;">â€»ãƒ—ãƒ¬ã‚¤çŠ¶æ³ã¯5ç§’ã”ã¨ã«è‡ªå‹•ã‚»ãƒ¼ãƒ–ã•ã‚Œã¾ã™</p>
        <div style="display:flex; gap:10px; margin-bottom:10px;">
            <button onclick="saveGame(1)" style="flex:1; padding:12px; background:#444; color:#fff; border:none; border-radius:6px; cursor:pointer;">æ‰‹å‹•ã‚»ãƒ¼ãƒ–1</button>
            <button onclick="loadGame(1)" style="flex:1; padding:12px; background:#0077ff; color:#fff; border:none; border-radius:6px; cursor:pointer;">æ‰‹å‹•ãƒ­ãƒ¼ãƒ‰1</button>
        </div>
        <div style="display:flex; gap:10px;">
            <button onclick="saveGame(2)" style="flex:1; padding:12px; background:#444; color:#fff; border:none; border-radius:6px; cursor:pointer;">æ‰‹å‹•ã‚»ãƒ¼ãƒ–2</button>
            <button onclick="loadGame(2)" style="flex:1; padding:12px; background:#0077ff; color:#fff; border:none; border-radius:6px; cursor:pointer;">æ‰‹å‹•ãƒ­ãƒ¼ãƒ‰2</button>
        </div>
        
        <button id="btn-play-ending" onclick="playEnding()" style="width:100%; margin-top:20px; background:#00ffcc; color:black; border:none; padding:12px; border-radius:6px; font-weight:bold; cursor:pointer; display:none;">ğŸï¸ ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¦‹ã‚‹</button>
        
        <button onclick="confirmFullReset()" style="width:100%; margin-top:20px; background:#ff0055; color:white; border:none; padding:12px; border-radius:6px; font-weight:bold; cursor:pointer;">ãƒ‡ãƒ¼ã‚¿å…¨å‰Šé™¤ (ãƒªã‚»ãƒƒãƒˆ)</button>

        <button onclick="openModal('modal-credit')" style="width:100%; margin-top:10px; background:#555; color:white; border:none; padding:12px; border-radius:6px; font-weight:bold; cursor:pointer;">ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚’è¦‹ã‚‹</button>
    </div>
</div>

<div id="modal-status" class="modal" style="padding: 20px;">
    <div class="modal-header-top" style="margin-bottom:10px;"><h3 style="margin:0;">è©³ç´°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3><span class="close" onclick="closeAllModals()">Ã—</span></div>
    <div id="status-content" style="font-size:14px; line-height:2.0; color:#ddd; background:#111; padding:15px; border-radius:8px; border:1px solid #333; margin-top:10px;"></div>
</div>

<div id="modal-confirm" class="modal" style="max-width:320px; text-align:center; padding: 20px;">
    <h3 style="color:#ff0055; margin-top:0;">âš ï¸ ãƒ‡ãƒ¼ã‚¿å…¨å‰Šé™¤</h3>
    <p style="font-size:14px; color:#ddd; margin-bottom:20px;">
        æœ¬å½“ã«ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¦<br>åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ<br>
        <span style="color:#ff5500;">â€»ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</span>
    </p>
    <div style="display:flex; gap:10px;">
        <button onclick="closeConfirmModal()" style="flex:1; padding:12px; background:#444; color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button onclick="executeFullReset()" style="flex:1; padding:12px; background:#ff0055; color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">å‰Šé™¤ã™ã‚‹</button>
    </div>
</div>

<div id="modal-credit" class="modal" style="padding: 20px;">
    <div class="modal-header-top" style="margin-bottom:10px;"><h3 style="margin:0;">ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ</h3><span class="close" onclick="closeAllModals()">Ã—</span></div>
    <div style="font-size:14px; line-height:1.8; color:#ccc; margin-top:10px; text-align:center;">
        <h2 style="color:#00ffcc; font-family:'DenkiChip', sans-serif; letter-spacing: 2px;">Timing Lock: Ultimate</h2>
        <p><strong>[ åˆ¶ä½œãƒ»æ¶ˆè²»ã‚¢ã‚¤ãƒ†ãƒ ã‚¤ãƒ©ã‚¹ãƒˆãƒ»ãƒ—ãƒ­ã‚°ãƒ©ãƒ  ]</strong><br>ç§‹å†¬IM</p>
        <p><strong>[ åˆ¶ä½œãƒ„ãƒ¼ãƒ« ]</strong><br>VScode</p>
        <p><strong>[ ãƒ•ã‚©ãƒ³ãƒˆ ]</strong><br>x8y12pxDenkiChip.ttf</p>
        <p><strong>[ ç´ æãƒ»SE ]</strong><br>ãƒ»OtoLogic<br>ãƒ»åŠ¹æœéŸ³ãƒ©ãƒœ<br>ãƒ»photo-ac<br>
        <p style="margin-top:20px; font-size:12px; color:#888;">Thank you for playing!</p>
    </div>
</div>

<script>
    const DEBUG_POINTS = 0; 

    let owned = [];
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const sBtn = new Audio('button.mp3');
    const sClick = new Audio('otoko.mp3');
    const sInterhon = new Audio('interhon.mp3');
    const sRezi = new Audio('rezi.mp3'); 
    const sEnd = new Audio('end.mp3');

    let state = {
        pts: DEBUG_POINTS, pending: 0, isPlaying: false, isPaused: false,
        isFever: false, isSlow: false, isBoss: false, hasReached100: false, hasTutorialDone: false, 
        tutorials: { boss: false, withdraw: false, upgrade: false, shop: false, consume: false, slow: false, fever: false }, 
        feverG: 0, combo: 0, score: 0, life: 1, tempLife: 0, gameSpd: 0.05, 
        slowC: 0, slowTimer: 0, heartTimer: 0, ticketTimer: 0, angle: 0, targetA: 0, targetW: 0.7, critOff: 0, bossDir: 1, bossSpeed: 0.01,
        bossShieldLeft: 0, direction: 1, hasDeath: false, deathA: 0, deathW: 0.3,
        maxScore: 0, maxCombo: 0,
        skin: { ring:'#333', effect:'none', sound:'default', needle:'default', g_btn:false, g_met:false, i_tikuwa:false, g_bomb:false, f_gorg:false, f_bg:false, g_neko:false },
        consumes: { c_heart: 0, c_pot: 0, c_oil: 0, c_timer: 0, c_cushion: 0, c_ticket: 0, c_magnet: 0, c_last: 0 },
        unlockedConsumes: {}, 
        buffs: { pot: 0, oil: 0, qTimer: false, cushion: 0, magnet: 0, last: false },
        settings: { vol: 0.5, showNum: true, feverSat: 100 },
        shopTab: 'skin'
    };
    
    let particles = [];

    function getCatColor(cat) {
        switch(cat) {
            case 'basic': return '#00ffcc';
            case 'fever': return '#ffeb3b';
            case 'boss':  return '#ff0055';
            case 'rng':   return '#ff8800';
            case 'system':return '#cc00ff';
            case 'toybox':return '#ff55cc'; 
            case 'god':   return '#ffffff';
            default:      return '#444';
        }
    }

    const skills = {
        life: { icon: "â¤ï¸", name:"ãƒ©ã‚¤ãƒ•+", desc:"ãƒŸã‚¹ã®è¨±å®¹å›æ•°ã‚’å¢—ã‚„ã—ã¾ã™ã€‚", flavor:"å¿ƒã®ä½™è£•ã€æ¬²ã—ããªã„ï¼Ÿ", base:30, step:30, defaultMax:5, max:5, lv:0, tier:0, active:true, cat:'basic' },
        pts:  { icon: "P", name:"ãƒã‚¤ãƒ³ãƒˆUP", desc:"åŸºç¤ç²å¾—é‡ã‚’å¢—åŠ ã•ã›ã¾ã™ã€‚", flavor:"å°ã•ãªç©ã¿é‡ã­ãŒã€ã‚„ãŒã¦è«å¤§ãªå¯Œã¸ã¨å¤‰ã‚ã‚‹ã€‚", base:20, step:20, defaultMax:20, max:20, lv:0, tier:0, active:true, cat:'basic', isLB:true },
        wide: { icon: "ğŸ¯", name:"ã‚¨ãƒªã‚¢æ‹¡å¤§", desc:"æˆåŠŸåˆ¤å®šã¨ãªã‚‹èµ¤ã„ã‚¨ãƒªã‚¢ã‚’å°‘ã—åºƒãã—ã¾ã™ã€‚", flavor:"æˆåŠŸã¸ã®çš„ã‚’åºƒã’ã¦ã„ãã€‚", base:20, step:10, defaultMax:10, max:10, lv:0, tier:0, active:true, cat:'basic' },
        gear: { icon: "âš™ï¸", name:"è»½é‡ã‚®ã‚¢", desc:"æˆåŠŸã‚’é‡ã­ãŸæ™‚ã®ã€é‡ã®åŠ é€Ÿã‚¹ãƒ”ãƒ¼ãƒ‰ã‚’æŠ‘ãˆã¾ã™ã€‚", flavor:"ç²¾å¯†ãªæ­¯è»ŠãŒã€æ™‚ã®æš´èµ°ã‚’å„ªã—ããªã ã‚ã‚‹ã€‚", base:400, step:400, defaultMax:5, max:5, lv:0, tier:11, active:true, cat:'basic', isLB:true }, 
        widePlus: { icon: "ğŸ¹", name:"ã‚¨ãƒªã‚¢æ‹¡å¤§+", desc:"èµ¤ã„ã‚¨ãƒªã‚¢ã‚’ã•ã‚‰ã«åºƒãã—ã¦ã€é›£æ˜“åº¦ã‚’å¤§å¹…ã«ä¸‹ã’ã¾ã™ã€‚", flavor:"ã‚‚ã¯ã‚„å¤–ã™ã“ã¨ã™ã‚‰é›£ã—ã„ã€‚çµ¶å¯¾çš„ãªè‡ªä¿¡ã®ç¾ã‚Œã€‚", base:1000, step:800, defaultMax:10, max:10, lv:0, tier:50, active:true, cat:'basic', isLB:true }, 
        ptsPlus:  { icon: "ğŸ’°", name:"ãƒã‚¤ãƒ³ãƒˆUP+", desc:"åŸºç¤ç²å¾—é‡ã‚’å¤§å¹…ã«ä¹—ç®—ã—ã€çˆ†ç™ºçš„ã«ç¨¼ã’ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚", flavor:"ä¸–ç•Œã®ç†ã«ä»‹å…¥ã—ã€å¯Œã®å¢—å¹…ã‚’åŠ é€Ÿã•ã›ã‚‹ã€‚", base:2000, step:1500, defaultMax:5, max:5, lv:0, tier:50, active:true, cat:'basic', isLB:true },
        antiReverse: { icon: "ğŸ”„", name:"èª¤ä½œå‹•é˜²æ­¢", desc:"ã‚¹ã‚³ã‚¢50ä»¥é™ã«ç™ºç”Ÿã™ã‚‹ã€Œé€†å›è»¢ã€ã®ç¢ºç‡ã‚’ä¸‹ã’ã¾ã™ã€‚", flavor:"é‹å‘½ã®é€†æµã«æŠ—ã†ã€å¼·é­ãªæ„å¿—ã®åŠ›ã€‚", base:300, step:200, defaultMax:2, max:2, lv:0, tier:0, active:true, cat:'basic' },

        crit: { icon: "âš¡", name:"ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«", desc:"ãƒã‚¤ãƒ³ãƒˆãŒ1.5å€ã«ãªã‚‹é»„è‰²ã„ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã‚¨ãƒªã‚¢ãŒå‡ºç¾ã—ã¾ã™ã€‚", flavor:"ä¸€ç¬ã®éš™ã‚’çªãã€ç ”ãæ¾„ã¾ã•ã‚ŒãŸé›†ä¸­åŠ›ã€‚", base:80, step:0, defaultMax:1, max:1, lv:0, tier:5, active:true, cat:'rng' },
        critRate: { icon: "ğŸ“ˆ", name:"ã‚¯ãƒªç‡UP", desc:"ã‚¨ãƒªã‚¢å¤–ã§ã‚‚ã€ç¢ºç‡ã§ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«åˆ¤å®šã«ãªã‚Šã¾ã™ã€‚", flavor:"å¥‡è·¡ã‚’å¿…ç„¶ã«å¤‰ãˆã‚‹ã€æã‚‹ã¹ãæ´å¯Ÿã€‚", base:200, step:150, defaultMax:10, max:10, lv:0, tier:6, active:true, cat:'rng', parent:'crit' }, 
        lucky:{ icon: "ğŸ€", name:"ãƒ©ãƒƒã‚­ãƒ¼", desc:"0.5%ã§ç²å¾—ãƒã‚¤ãƒ³ãƒˆãŒ3å€ã«ãªã‚‹ãƒ©ãƒƒã‚­ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚", flavor:"é‹å‘½ã®å¥³ç¥ãŒã€ã‚ãªãŸã«å¾®ç¬‘ã¿ã‹ã‘ã¦ã„ã‚‹ã€‚", base:250, step:0, defaultMax:1, max:1, lv:0, tier:5, active:true, cat:'rng' },
        recovery: { icon: "ğŸ’Š", name:"ãƒªã‚«ãƒãƒªãƒ¼", desc:"ãƒŸã‚¹ã—ãŸæ™‚ã«ã€ç¢ºç‡ã§ãƒ©ã‚¤ãƒ•ãŒæ¸›ã‚‰ãªã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚", flavor:"æ­»ã®æ·µã‹ã‚‰è˜‡ã‚‹ã€ä¸å±ˆã®ç²¾ç¥ã€‚", base:250, step:200, defaultMax:5, max:5, lv:0, tier:7, active:true, cat:'rng' },

        slow: { icon: "â±ï¸", name:"ã‚¹ãƒ­ãƒ¼", desc:"ã‚²ãƒ¼ãƒ ä¸­ã«Sã‚­ãƒ¼ã‚’æŠ¼ã™ã¨ã€ä¸€å®šæ™‚é–“é‡ãŒã‚¹ãƒ­ãƒ¼ã«ãªã‚Šã¾ã™ã€‚", flavor:"ä¸–ç•ŒãŒè‰²è¤ªã›ã€æ™‚ã®æµã‚ŒãŒæ³¥ã®ã‚ˆã†ã«é…ããªã‚‹ã€‚", base:60, step:50, defaultMax:5, max:5, lv:0, tier:3, active:true, cat:'system' },
        discount: { icon: "ğŸ«", name:"å‰²å¼•", desc:"ä»–ã®ã™ã¹ã¦ã®å¼·åŒ–ã«å¿…è¦ãªãƒã‚¤ãƒ³ãƒˆãŒæ¸›å°‘ã—ã¾ã™ã€‚", flavor:"å–å¼•ã®æ¥µæ„ã€‚å…¨ã¦ã®å¯¾ä¾¡ã¯ã€äº¤æ¸‰æ¬¡ç¬¬ã§ä¸‹ãŒã‚‹ã€‚", base:500, step:400, defaultMax:3, max:3, lv:0, tier:4, active:true, cat:'system' },
        comboBonus: { icon: "ğŸ”¥", name:"ã‚³ãƒ³ãƒœå¼·åŒ–", desc:"ã‚³ãƒ³ãƒœæ•°ãŒç¶šãã»ã©ã€ç²å¾—ãƒã‚¤ãƒ³ãƒˆã«ãƒœãƒ¼ãƒŠã‚¹ãŒä»˜ãã¾ã™ã€‚", flavor:"æ­¢ã¾ã‚‰ãªã„é€£æ’ƒãŒã€ã‹ã¤ã¦ãªã„ç†±ç‹‚ã‚’å‘¼ã¶ã€‚", base:150, step:80, defaultMax:5, max:5, lv:0, tier:4, active:true, cat:'system' }, 
        ins:  { icon: "ğŸ¦", name:"æ­»äº¡ä¿é™º", desc:"ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã«ãªã£ãŸæ™‚ã«å¿…ãšæŒã¡å¸°ã‚Œã‚‹æœ€ä½ä¿è¨¼ãƒã‚¤ãƒ³ãƒˆãŒå¢—ãˆã¾ã™ã€‚", flavor:"æœ€æ‚ªã®äº‹æ…‹ã«å‚™ãˆã‚‹ã€‚ãã‚ŒãŒãƒ—ãƒ­ã®æµå„€ã ã€‚", base:30, step:20, defaultMax:25, max:25, lv:0, tier:5, active:true, cat:'system' },
        wideKeep: { icon: "ğŸ›¡ï¸", name:"ãƒ¯ã‚¤ãƒ‰ã‚­ãƒ¼ãƒ—", desc:"ã‚¹ã‚³ã‚¢ãŒé€²ã‚€ã«ã¤ã‚Œã¦ã‚¨ãƒªã‚¢ãŒç‹­ããªã‚‹ã®ã‚’æŠ‘ãˆã¾ã™ã€‚", flavor:"ã©ã‚“ãªã«è¿½ã„è©°ã‚ã‚‰ã‚Œã¦ã‚‚ã€æ±ºã—ã¦è¦–é‡ã‚’ç‹­ã‚ãªã„ã€‚", base:400, step:300, defaultMax:5, max:5, lv:0, tier:9, active:true, cat:'system' }, 
        auto: { icon: "ğŸ•°ï¸", name:"ã‚ªãƒ¼ãƒˆæ™‚è¨ˆ", desc:"æ”¾ç½®ã—ã¦ã„ã‚‹ã ã‘ã§è‡ªå‹•çš„ã«ãƒã‚¤ãƒ³ãƒˆã‚’ç¨¼ã„ã§ãã‚Œã¾ã™ã€‚", flavor:"ã‚ãªãŸãŒä¼‘ã‚“ã§ã„ã‚‹é–“ã‚‚ã€æ™‚è¨ˆã¯ãƒã‚¯ã‚¿ã‚¯ã¨æ™‚ã‚’åˆ»ã‚€ã€‚", base:200, step:150, defaultMax:15, max:15, lv:0, tier:10, active:true, cat:'system' },
        autoEff: { icon: "ğŸ”‹", name:"ã‚ªãƒ¼ãƒˆæ™‚è¨ˆåŠ¹ç‡", desc:"ã‚ªãƒ¼ãƒˆæ™‚è¨ˆã‹ã‚‰å¾—ã‚‰ã‚Œã‚‹ãƒã‚¤ãƒ³ãƒˆã‚’å¢—åŠ ã•ã›ã¾ã™ã€‚", flavor:"æ­¯è»Šã«æ²¹ã‚’æ³¨ãã€å…¨è‡ªå‹•ã®æ©æµã‚’æ¥µé™ã¾ã§é«˜ã‚ã‚‹ã€‚", base:300, step:250, defaultMax:20, max:20, lv:0, tier:15, active:true, cat:'system', parent:'auto' },
        
        toybox: { icon: "ğŸ§¸", name:"ãŠã‚‚ã¡ã‚ƒç®±", desc:"ã‚·ãƒ§ãƒƒãƒ—ã«ã€Œæ¶ˆè²»ã‚¢ã‚¤ãƒ†ãƒ ã€ã®ã‚«ãƒ†ã‚´ãƒªãŒè¿½åŠ ã•ã‚Œã¾ã™ã€‚", flavor:"ã€Œã‚¬ãƒ©ã‚¯ã‚¿ã‹ã€å®ç‰©ã‹ã€‚ã¨ã«ã‹ãå½¹ç«‹ã¤æ–°å•†å“ã‚’ãã‚ãˆã¦ã¿ãŸãœã€‚ã€byã‚·ãƒ§ãƒƒãƒ—åº—é•·", base:1000, step:0, defaultMax:1, max:1, lv:0, tier:10, active:true, noToggle:true, cat:'toybox' },

        bossShield: { icon: "ğŸ›¡ï¸", name:"ãƒœã‚¹ã‚·ãƒ¼ãƒ«ãƒ‰", desc:"ãƒœã‚¹æˆ¦ã§ã®ãƒŸã‚¹ã‚’å›æ•°åˆ†ã ã‘ç„¡åŠ¹åŒ–ã—ã¦ãã‚Œã¾ã™ã€‚", flavor:"å¼·å¤§ãªæ•µã®ä¸€æ’ƒã‚’ã€è¦‹ãˆãªã„éšœå£ãŒå¼¾ãè¿”ã™ã€‚", base:600, step:600, defaultMax:2, max:2, lv:0, tier:25, active:true, cat:'boss' },
        bossSlow: { icon: "ğŸ‘ï¸", name:"ãƒœã‚¹å¨åœ§", desc:"ãƒœã‚¹æˆ¦çªå…¥æ™‚ã«ã€ç¢ºç‡ã§è‡ªå‹•çš„ã«ã‚¹ãƒ­ãƒ¼ãŒç™ºå‹•ã—ã¾ã™ã€‚", flavor:"ã‚ãªãŸã®æ”¾ã¤å¨åœ§æ„ŸãŒã€æ•µã®å‹•ãã‚’éˆã‚‰ã›ã‚‹ã€‚", base:800, step:600, defaultMax:5, max:5, lv:0, tier:25, active:true, cat:'boss' },

        fever:{ icon: "ğŸŒŸ", name:"ãƒ•ã‚£ãƒ¼ãƒãƒ¼", desc:"ã‚²ãƒ¼ã‚¸ãŒæº€ã‚¿ãƒ³ã«ãªã‚‹ã¨ã€ä¸€å®šæ™‚é–“ç„¡æ•µã§é€£æ‰“ã—æ”¾é¡Œã«ãªã‚Šã¾ã™ã€‚", flavor:"é™ç•Œã‚’è¶…ãˆãŸå…ˆã«ã‚ã‚‹ã€é»„é‡‘è‰²ã«è¼ãç†±ç‹‚ã®é ˜åŸŸã€‚", base:300, step:300, defaultMax:5, max:5, lv:0, tier:15, active:true, cat:'fever' },
        feverTime: { icon: "â³", name:"Fã‚¿ã‚¤ãƒ å»¶é•·", desc:"ãƒ•ã‚£ãƒ¼ãƒãƒ¼çŠ¶æ…‹ã®æŒç¶šæ™‚é–“ã‚’å»¶é•·ã—ã¾ã™ã€‚", flavor:"çµ‚ã‚ã‚‰ãªã„ç‹‚å®´ã€‚ã“ã®ç†±ç‹‚ã¯ã¾ã å†·ã‚ã‚„ã‚‰ãªã„ã€‚", base:600, step:600, defaultMax:5, max:5, lv:0, tier:16, active:true, cat:'fever', parent:'fever' },
        feverBoost: { icon: "ğŸ’¥", name:"Fãƒœãƒ¼ãƒŠã‚¹", desc:"ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã«ç²å¾—ã§ãã‚‹ãƒã‚¤ãƒ³ãƒˆã®å€ç‡ãŒä¸ŠãŒã‚Šã¾ã™ã€‚", flavor:"ç†±ç‹‚ã®æ¸¦ã®ä¸­ã§ã€å¯Œã¯çˆ†ç™ºçš„ã«è†¨ã‚Œä¸ŠãŒã‚‹ã€‚", base:500, step:500, defaultMax:5, max:5, lv:0, tier:18, active:true, cat:'fever', parent:'fever' }, 

        ending: { icon: "ğŸ¬", name:"çœŸå®Ÿã®æ‰‰", desc:"è¨­å®šç”»é¢ã‹ã‚‰ã‚²ãƒ¼ãƒ ã®ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¦‹ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚", flavor:"ã™ã¹ã¦ã®é‡ãŒé‡ãªã‚‹æ™‚ã€æœ¬å½“ã®çµæœ«ãŒç›®ã‚’è¦šã¾ã™ã€‚", base:3000, step:0, defaultMax:1, max:1, lv:0, tier:12, active:true, cat:'god' }, 
        godMode: { icon: "ğŸ‘‘", name:"ç¥ã®é ˜åŸŸ", desc:"çµ¶å¯¾æˆåŠŸé ˜åŸŸã‚’å±•é–‹ã—ã€ãƒã‚¤ãƒ³ãƒˆãŒå¸¸æ™‚10å€ã«ãªã‚Šã¾ã™ã€‚", flavor:"ã‚‚ã¯ã‚„ã‚²ãƒ¼ãƒ ã§ã¯ãªã„ã€‚ã‚ãªãŸãŒã“ã®ä¸–ç•Œã®ãƒ«ãƒ¼ãƒ«ã ã€‚", base:50000, step:0, defaultMax:1, max:1, lv:0, tier:17, active:true, cat:'god', parent:'ending' },
        limitBreak: { icon: "ğŸ”¥", name:"é™ç•Œçªç ´", desc:"ä¸€éƒ¨ã®å¼·åŒ–(Ptç³»ã€ã‚®ã‚¢ã€ã‚¨ãƒªã‚¢æ‹¡å¤§+)ã®Lvä¸Šé™ã‚’999ã¾ã§å¼•ãä¸Šã’ã‚‹ã€‚", flavor:"é™ç•Œã®å…ˆã¸ã€‚ç¥ã™ã‚‰ã‚‚è¸ã¿å…¥ã‚‰ã¬ç„¡é™ã®é ˜åŸŸã€‚", base:50000, step:0, defaultMax:1, max:1, lv:0, tier:20, active:true, cat:'god', parent:'ending' } 
    };

    const shopItems = {
        's_blue': { icon:"ğŸŸ¦", name:"ãƒ–ãƒ«ãƒ¼ãƒã‚ªãƒ³", type:'skin', cost:400, desc:"ãƒªãƒ³ã‚°ã‚’é’ã«ã™ã‚‹", flavor:"ã‚¯ãƒ¼ãƒ«ãªé™å¯‚ã€‚", val:'#00ccff' },
        's_gold': { icon:"ğŸŸ¨", name:"ã‚´ãƒ¼ãƒ«ãƒ‰ãƒªãƒ ", type:'skin', cost:800, desc:"ãƒªãƒ³ã‚°ã‚’é‡‘ã«ã™ã‚‹(å¸¸æ™‚ç™ºå…‰)", flavor:"æˆé‡‘è¶£å‘³ã¨ã¯è¨€ã‚ã›ãªã„ã€‚ãŸã ã¾ã¶ã—ã™ãã‚‹", val:'#ffd700' },
        's_white':{ icon:"â¬œ", name:"ãƒ›ãƒ¯ã‚¤ãƒˆ", type:'skin', cost:400, desc:"ãƒªãƒ³ã‚°ã‚’ç™½ã«ã™ã‚‹(å¸¸æ™‚ç™ºå…‰)", flavor:"ç´”ç™½ã®è¼ãã€‚", val:'#ffffff' },
        's_red':  { icon:"ğŸŸ¥", name:"ãƒ¬ãƒƒãƒ‰ãƒ•ãƒ¬ã‚¢", type:'skin', cost:400, desc:"ãƒªãƒ³ã‚°ã‚’èµ¤ã«ã™ã‚‹", flavor:"èµ¤ã™ãã¦ä½•ã‚‚è¦‹ãˆãªã„ã€‚", val:'#ff0055' },
        's_real_n':{ icon:"ğŸ—¡ï¸", name:"é»„é‡‘ã®é‡", type:'needle', cost:2500, desc:"é‡ã‚’é»„é‡‘ã«ã™ã‚‹", flavor:"æ™‚ã‚’åˆ»ã‚€ã®ã«ãµã•ã‚ã—ã„é€¸å“ã€‚", val:'real_needle' },
        'e_thun': { icon:"âš¡", name:"é›·ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ", type:'effect', cost:2500, desc:"ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ’ãƒƒãƒˆæ™‚ã«é›·ç™ºç”Ÿ", flavor:"ãƒ“ãƒªãƒ“ãƒªãã‚‹ãœã€‚", val:'thunder' },
        'e_party':{ icon:"âœ¨", name:"ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«", type:'effect', cost:4000, desc:"ãƒ’ãƒƒãƒˆæ™‚ã«æ˜Ÿå±‘ãŒæ•£ã‚‹", flavor:"ç”»é¢ã‚’é®®ã‚„ã‹ã«å½©ã‚‹æ˜Ÿå±‘ã€‚", val:'particle' }, 
        'f_bg':   { icon:"ğŸŒ", name:"ã‚µã‚¤ãƒãƒ¼èƒŒæ™¯", type:'facility', cost:4000, desc:"èƒŒæ™¯ã«ãƒ‡ã‚¸ã‚¿ãƒ«ã‚°ãƒªãƒƒãƒ‰ã‚’æç”»", flavor:"ãƒãƒƒã‚«ãƒ¼æ°—åˆ†ã‚’å‘³ã‚ãˆã‚‹é›»è„³ç©ºé–“ã€‚", val:'cyber_bg' }, 
        'sd_clk': { icon:"ğŸ–±ï¸", name:"ã‚«ãƒãƒƒéŸ³", type:'sound', cost:800, desc:"ã‚¯ãƒªãƒƒã‚¯éŸ³å¤‰æ›´", flavor:"å¿ƒåœ°ã‚ˆã„ãƒ¡ã‚«ãƒ‹ã‚«ãƒ«ã‚¹ã‚¤ãƒƒãƒã®éŸ¿ãã€‚", val:'click_file' },
        'g_btn':  { icon:"ğŸ”´", name:"ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ›ãƒ³", type:'gadget', cost:1500, desc:"å³å´ã«ãƒœã‚¿ãƒ³è¿½åŠ ", flavor:"ç„¡æ€§ã«æŠ¼ã—ãŸããªã‚‹ã‚ã®ãƒœã‚¿ãƒ³ã€‚", val:'g_btn' },
        'g_met':  { icon:"â±ï¸", name:"ãƒ¡ãƒˆãƒ­ãƒãƒ¼ãƒ ", type:'gadget', cost:1500, desc:"ãƒªã‚ºãƒ ã‚’åˆ»ã‚€", flavor:"ä¸€å®šã®ãƒ†ãƒ³ãƒãŒé›†ä¸­åŠ›ã‚’é«˜ã‚ã‚‹ã€‚", val:'g_met' },
        'g_bomb': { icon:"ğŸ’£", name:"çˆ†å¼¾ãƒœã‚¿ãƒ³", type:'gadget', cost:3000, desc:"ã“ã‚Œã‹ã‚‰æ¯æ—¥çˆ†ç ´ã—ã‚ˆã†ãœï¼Ÿ", flavor:"æŠ¼ã™ã¨çˆ†ç™ºã™ã‚‹ã€‚ãŸã ãã‚Œã ã‘ã ã€‚", val:'g_bomb' },
        'f_gorg': { icon:"ğŸ”¤", name:"ãƒãƒƒãƒ—é¢¨ãƒ•ã‚©ãƒ³ãƒˆ", type:'font', cost:4000, desc:"æ–‡å­—ãŒãƒãƒƒãƒ—é¢¨ã®ãƒ•ã‚©ãƒ³ãƒˆã«ãªã‚‹", flavor:"ãƒ¬ãƒˆãƒ­ãªé›°å›²æ°—ã‚’é†¸ã—å‡ºã™ã€‚", val:'f_gorg' },
        'i_tikuwa':{ icon:"<img src='tikuwa.png'>", name:"ã¡ãã‚", type:'item', cost:7000, desc:"é«˜ç´šãªã¡ãã‚", flavor:"ãªãœã¡ãã‚ï¼Ÿè€ƒãˆã‚‹ãªã€æ„Ÿã˜ã‚ã€‚", val:'i_tikuwa' },
        'g_neko': { icon:"ğŸ±", name:"æ‹›ãçŒ«", type:'gadget', cost:5000, desc:"å³å´ã«é®åº§ã™ã‚‹ã€‚ãŸã¾ã«ãƒã‚¤ãƒ³ãƒˆã‚’æ‹¾ã†ã€‚", flavor:"ãƒãƒªã‚‚ç©ã‚‚ã‚Œã°ãªã‚“ã¨ã‚„ã‚‰ã€‚è‡ªå‹•ã§æ™‚ã€…1Ptã‚‚ã‚‰ãˆã‚‹ãã€‚", val:'g_neko' }
    };

    const consumeItems = {
        'c_heart': { name:"ã¨ã‚“ã“ã¤ãƒ©ãƒ¼ãƒ¡ãƒ³", short:"ãƒ©ã‚¤ãƒ•+1(60ç§’)", desc:"ä¸€æ™‚çš„ã«ãƒ©ã‚¤ãƒ•æ ã‚’+1ã™ã‚‹ã€‚\n(1åˆ†é–“æŒç¶šã€‚é‡è¤‡å¯èƒ½)", flavor:"ã“ã£ã¦ã‚Šã‚¹ãƒ¼ãƒ—ãŒä½“ã«æŸ“ã¿æ¸¡ã‚‹ã€‚", cost: 1500, img: 'lamen.png' },
        'c_pot': { name:"é«˜ãã†ãªå£º", short:"ãƒ©ãƒƒã‚­ãƒ¼ç‡+15%", desc:"ãƒ©ãƒƒã‚­ãƒ¼ç™ºå‹•ç‡+15%ã€‚é‡è¤‡å¯ã€‚\n(ç™ºå‹•ã™ã‚‹ã¨1ã¤å£Šã‚Œã‚‹)", flavor:"æ€ªã—ã„å…‰ã‚’æ”¾ã¤å£ºã€‚ã”åˆ©ç›ŠãŒã‚ã‚‹ã‚‰ã—ã„ã€‚", cost: 1200, img: 'tubo.png' },
        'c_oil': { name:"ã‚ˆãæ»‘ã‚‹æ²¹", short:"é‡é€Ÿåº¦x1.5", desc:"é‡ã®åŸºæœ¬ã‚¹ãƒ”ãƒ¼ãƒ‰ãŒ1.5å€ã«ãªã‚‹ã€‚é‡è¤‡å¯ã€‚\n(ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã¾ã§æŒç¶š)", flavor:"æ­¯è»Šã‚’ãƒ„ãƒ«ãƒ„ãƒ«ã«ã™ã‚‹å±é™ºãªæ²¹ã€‚", cost: 200, img: 'oil.png' },
        'c_timer': { name:"ã‚¯ã‚¤ãƒƒã‚¯ã‚¿ã‚¤ãƒãƒ¼", short:"æ™‚è¨ˆé–“éš”åŠæ¸›", desc:"ã‚ªãƒ¼ãƒˆæ™‚è¨ˆã®é–“éš”ã‚’åŠåˆ†ã«ã™ã‚‹ã€‚\n(ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã¾ã§æŒç¶šã€‚é‡è¤‡ä¸å¯)", flavor:"æ™‚é–“ã‚’å‰Šã‚Šå–ã‚‹é­”æ³•ã®ã‚¿ã‚¤ãƒãƒ¼ã€‚", cost: 1500, img: 'watchup.png' },
        'c_cushion': { name:"é˜²è­·ã‚¯ãƒƒã‚·ãƒ§ãƒ³", short:"GameOverä¿è­·", desc:"ãƒŸã‚¹ã§çµ‚ã‚ã‚‹æ™‚ã«è‡ªå‹•ã§æŒã¡å¸°ã‚Šã‚’ç™ºå‹•ã™ã‚‹ã€‚\n(ç™ºå‹•ã¾ã§æŒç¶šã€‚é‡è¤‡ä¸å¯)", flavor:"è½ã¡ãŸæ™‚ã®è¡æ’ƒã‚’å„ªã—ãå¸åã—ã¦ãã‚Œã‚‹ã€‚", cost: 2500, img: 'bougo.png' },
        'c_ticket': { name:"é»„é‡‘ã®ãƒã‚±ãƒƒãƒˆ", short:"Pt2å€(60ç§’)", desc:"1åˆ†é–“ã€ã™ã¹ã¦ã®ç²å¾—ãƒã‚¤ãƒ³ãƒˆãŒ2å€ã«ãªã‚‹ã€‚\n(é‡è¤‡ã§æ™‚é–“å»¶é•·)", flavor:"é¸ã°ã‚Œã—è€…ã«ã®ã¿ä¸ãˆã‚‰ã‚Œã‚‹é»„é‡‘ã®è¼ãã€‚", cost: 4000, img: 'tiket.png' },
        'c_magnet': { name:"ç£çŸ³", short:"çš„MAX(5å›)", desc:"æ¬¡ã®5å›ã€çš„ã®åºƒã•ãŒæœ€å¤§ã«ãªã‚‹ã€‚", flavor:"æˆåŠŸã‚’å¼·å¼•ã«å¼•ãå¯„ã›ã‚‹å¼·åŠ›ãªç£åŠ›ã€‚", cost: 8000, img: 'magnet.png' },
        'c_last': { name:"èƒŒæ°´ã®é™£", short:"å¸¸æ™‚é«˜é›£æ˜“åº¦ãƒœã‚¹(HP1ã®æ™‚ã®ã¿ä½¿ç”¨å¯)", desc:"ãƒ©ã‚¤ãƒ•ãŒ1ã®æ™‚ã®ã¿ä½¿ç”¨å¯èƒ½ã€‚\næ¯å›å°‘ã—é›£ã—ã„ãƒœã‚¹æˆ¦ãŒç™ºç”Ÿã™ã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚\n(ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã¾ã§æŒç¶šã€‚é‡è¤‡ä¸å¯)", flavor:"é€€è·¯ã‚’æ–­ã¡ã€å·±ã®å…¨åŠ›ã‚’è§£æ”¾ã›ã‚ˆã€‚", cost: 10000, img: 'haisui.png' }
    };

    function getCost(s) {
        let l = s.lv;
        let c = s.base + l * s.step;
        let maxVal = (isA('limitBreak') && s.isLB) ? 999 : (s.defaultMax || s.max);
        
        if (s.isLB && l >= s.defaultMax) {
            let over = l - s.defaultMax;
            let baseMaxCost = s.base + s.defaultMax * s.step;
            c = baseMaxCost + (over + 1) * (s.step * 5) + Math.pow(over, 2) * 100;
        }

        let rates = [0, 0.05, 0.10, 0.25];
        let discount = isA('discount') ? (rates[skills.discount.lv] || 0) : 0;
        return Math.floor(c * (1 - discount));
    }

    function getEffectVal(k, lv) {
        if(k==='life') return `+${lv}`;
        if(k==='pts') return `+${lv}`;
        if(k==='ptsPlus') return `x${1+lv}`;
        if(k==='wide' || k==='widePlus') return `+${lv*5}%`;
        if(k==='gear') return `ç·©å’ŒLv${lv}`;
        if(k==='antiReverse') return `-${lv*10}%`;
        
        if(k==='crit' || k==='lucky' || k==='toybox' || k==='ending' || k==='godMode' || k==='limitBreak') return lv>0 ? 'è§£æ”¾æ¸ˆ' : 'æœªè§£æ”¾';
        if(k==='critRate') return `+${(lv*0.2).toFixed(1)}%`;
        if(k==='recovery') return `${lv*5}%`;
        
        if(k==='slow') return lv===0 ? 'ãªã—' : `${lv>=2 ? 2 : 1}ç§’/${lv + (lv>=3 ? lv-2 : 0)}å›`;
        if(k==='discount') return `${lv === 0 ? 0 : [0, 5, 10, 25, 25][lv]}%`;
        
        // â–¼ ã‚³ãƒ³ãƒœå¼·åŒ–ã®ãƒ†ã‚­ã‚¹ãƒˆä¿®æ­£
        if(k==='comboBonus') return `ã‚³ãƒ³ãƒœæ¯ã«+${lv*3}%`;
        
        if(k==='ins') return `${15+lv*45}pt`;
        if(k==='wideKeep') return `ç¶­æŒLv${lv}`;
        if(k==='auto') return lv===0 ? 'ãªã—' : `${1+Math.floor((lv-1)/5)}å€‹(${(10000-((lv-1)%5)*1800)/1000}s)`;
        if(k==='autoEff') return lv===0 ? '+0pt' : `+${9 + (lv - 1) * 10}pt`;
        
        if(k==='bossShield') return `${lv}å›`;
        if(k==='bossSlow') return `${lv*20}%`;
        
        if(k==='fever') return `ã‚²ãƒ¼ã‚¸å¢—åŠ é‡ +${(lv*0.5).toFixed(1)}`;
        if(k==='feverTime') return `+${lv}ç§’`;
        if(k==='feverBoost') return `+${lv*20}%`;
        
        return `Lv${lv}`;
    }

    function isA(k) { return skills[k] && skills[k].lv > 0 && skills[k].active; }

    function playTone(type, freq, decay) {
        if(audioCtx.state==='suspended') audioCtx.resume();
        const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
        o.type=type; o.frequency.setValueAtTime(freq, audioCtx.currentTime);
        g.gain.setValueAtTime(state.settings.vol, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime+decay);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime+decay);
    }
    function playBtn(){ sBtn.volume=state.settings.vol; sBtn.currentTime=0; sBtn.play().catch(()=>playTone('sine',600,0.1)); }
    function playRezi(){ sRezi.volume=state.settings.vol; sRezi.currentTime=0; sRezi.play().catch(()=>playTone('triangle',1200,0.1)); }
    function playHit(crit, fever){
        if(fever){ playTone('square', 800 + Math.random()*800, 0.08); return; }
        if(state.skin.sound==='click_file'){ 
            sClick.volume=state.settings.vol * 0.5; // ã‚¯ãƒªãƒƒã‚¯éŸ³é‡ã‚’åŠæ¸›
            sClick.currentTime=0; 
            sClick.play().catch(()=>playTone('triangle',1000,0.05)); 
        }
        else {
            if(crit) { playTone('triangle', 1046, 0.2); setTimeout(()=>playTone('sine', 1318, 0.3), 30); } 
            else { playTone('sine', 400+(state.score%10)*30, 0.1); }
        }
    }
    
    function applyFont() { 
        document.body.style.fontFamily = state.skin.f_gorg ? "'DenkiChip', 'Helvetica Neue', Arial, sans-serif" : "'Helvetica Neue', Arial, sans-serif"; 
    }

    function showFloatingText(txt, color) {
        if(!state.settings.showNum) return;
        const el = document.createElement('div');
        el.innerText = txt; el.className = 'floating-text'; el.style.color = color;
        const angle = Math.random() * Math.PI * 2; const r = 90 + Math.random() * 40;
        el.style.left = `calc(50% + ${Math.cos(angle) * r - 20}px)`; 
        el.style.top = `calc(50% + ${Math.sin(angle) * r - 10}px)`;
        document.querySelector('.game-area').appendChild(el);
        setTimeout(() => el.remove(), 1000);
    }

    function toggleNumbers() {
        playBtn(); state.settings.showNum = !state.settings.showNum;
        let btn = document.getElementById('toggle-num-btn');
        btn.innerText = state.settings.showNum ? "ON" : "OFF";
        btn.className = state.settings.showNum ? "toggle-btn on" : "toggle-btn";
    }

    document.getElementById('btn-start').onclick = () => {
        playBtn();
        document.getElementById('title-screen').style.display = 'none';
        document.getElementById('modal-start-help').style.display = 'block';
    };

    document.getElementById('btn-close-start-help').onclick = () => {
        playBtn();
        document.getElementById('modal-start-help').style.display = 'none';
        document.getElementById('main-ui').style.display = 'flex';
        updateUI();
        init();
    };

    // --- ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤ºå‡¦ç† ---
    let wasPausedBeforeTutorial = false; // ãƒãƒ¼ã‚ºçŠ¶æ…‹ã‚’è¨˜æ†¶ã™ã‚‹å¤‰æ•°
    
    function showTutorial(type) {
        wasPausedBeforeTutorial = state.isPaused; // é–‹ãå‰ã®ãƒãƒ¼ã‚ºçŠ¶æ…‹ã‚’è¨˜æ†¶
        state.isPaused = true; // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ä¸­ã¯ç¢ºå®Ÿã«ãƒãƒ¼ã‚ºã™ã‚‹
        
        const modal = document.getElementById('modal-tutorial');
        const title = document.getElementById('tut-title');
        const desc = document.getElementById('tut-desc');
        
        if(type === 'withdraw') {
            title.innerText = "ğŸ’¡ ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«: æŒã¡å¸°ã‚Š";
            desc.innerHTML = "ãƒ©ã‚¤ãƒ•ãŒ0ã«ãªã‚‹ã¨ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã«ãªã‚Šã€<br>ç¨¼ã„ã ãƒã‚¤ãƒ³ãƒˆãŒå¤§ããæ¸›ã£ã¦ã—ã¾ã„ã¾ã™ï¼<br><br>ãƒŸã‚¹ã—ãã†ã«ãªã£ãŸã‚‰ã€æ‰‹é…ã‚Œã«ãªã‚‹å‰ã«<br><span style='color:#ff5500; font-weight:bold;'>ã€ŒğŸ’° ãƒã‚¤ãƒ³ãƒˆæŒã¡å¸°ã‚Šã€</span>ã‚’æŠ¼ã—ã¦<br>å®‰å…¨ã«ãƒã‚¤ãƒ³ãƒˆã‚’ç¢ºå®šã•ã›ã¾ã—ã‚‡ã†ï¼";
        } else if(type === 'boss') {
            title.innerText = "âš ï¸ ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«: ãƒœã‚¹æˆ¦";
            desc.innerHTML = "ã‚¹ã‚³ã‚¢10ã”ã¨ã«<span style='color:#ff0055; font-weight:bold;'>ã€Œãƒœã‚¹æˆ¦ã€</span>ãŒç™ºç”Ÿã—ã¾ã™ï¼<br><br>èµ¤ã„çš„ãŒå‹•ãã‚ˆã†ã«ãªã‚Šé›£æ˜“åº¦ãŒä¸ŠãŒã‚Šã¾ã™ãŒã€<br>æˆåŠŸã™ã‚Œã°å¤§é‡ã®ãƒœãƒ¼ãƒŠã‚¹ãƒã‚¤ãƒ³ãƒˆã‚’ç²å¾—ã§ãã¾ã™ã€‚<br>è½ã¡ç€ã„ã¦ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’åˆã‚ã›ã¾ã—ã‚‡ã†ï¼";
        } else if(type === 'upgrade') {
            title.innerText = "ğŸ”§ ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«: å¼·åŒ–ãƒ©ãƒœ";
            desc.innerHTML = "ç„¡äº‹ãƒã‚¤ãƒ³ãƒˆã‚’æŒã¡å¸°ã‚Œã¾ã—ãŸã­ï¼<br><br>ç”»é¢ä¸‹éƒ¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®<span style='color:#0077ff; font-weight:bold;'>ã€ŒğŸ”§ å¼·åŒ–ãƒ©ãƒœã€</span>ã‹ã‚‰ã€<br>é›†ã‚ãŸãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ã£ã¦èƒ½åŠ›ã‚’è§£æ”¾ã§ãã¾ã™ã€‚<br>ã¾ãšã¯ã€Œãƒ©ã‚¤ãƒ•+ã€ã‚„ã€Œãƒã‚¤ãƒ³ãƒˆUPã€ãŒãŠã™ã™ã‚ã§ã™ï¼";
        } else if(type === 'shop') {
            title.innerText = "ğŸ ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«: ã‚·ãƒ§ãƒƒãƒ—";
            desc.innerHTML = "ã‚·ãƒ§ãƒƒãƒ—ã§ã¯ã€é›†ã‚ãŸãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ã£ã¦<br>è¦‹ãŸç›®ã‚„BGMãªã©ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã¾ã™ï¼<br><br>è³¼å…¥ã—ãŸå¾Œã¯ã€å¿˜ã‚Œãšã«<span style='color:#ff0055; font-weight:bold;'>ã€Œè£…å‚™ã€</span>ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦<br>é©ç”¨ã—ã¦ãã ã•ã„ã­ï¼";
        } else if(type === 'consume') {
            title.innerText = "ğŸ§¸ ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«: æ¶ˆè²»ã‚¢ã‚¤ãƒ†ãƒ ";
            desc.innerHTML = "ã€ŒãŠã‚‚ã¡ã‚ƒç®±ã€ã‚’è§£æ”¾ã—ãŸã“ã¨ã§ã€<br>ä½¿ã„æ¨ã¦ã®<span style='color:#ff55cc; font-weight:bold;'>æ¶ˆè²»ã‚¢ã‚¤ãƒ†ãƒ </span>ãŒè²·ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸï¼<br><br>è³¼å…¥ã—ãŸã‚¢ã‚¤ãƒ†ãƒ ã¯ã€ã‚²ãƒ¼ãƒ ç”»é¢ã®å³å´<br>ï¼ˆã‚¹ãƒãƒ›ãªã‚‰ç”»é¢ä¸‹éƒ¨ï¼‰ã®ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã‹ã‚‰<br>ã‚¿ãƒƒãƒ—ã—ã¦ä½¿ç”¨ã§ãã¾ã™ï¼";
        } else if(type === 'slow') {
            title.innerText = "â±ï¸ ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«: ã‚¹ãƒ­ãƒ¼æ©Ÿèƒ½";
            desc.innerHTML = "å¼·åŠ›ãª<span style='color:#00ffff; font-weight:bold;'>ã€Œã‚¹ãƒ­ãƒ¼ã€</span>æ©Ÿèƒ½ãŒè§£æ”¾ã•ã‚Œã¾ã—ãŸï¼<br><br>ã‚²ãƒ¼ãƒ ä¸­ã«ãƒ”ãƒ³ãƒã«ãªã£ãŸã‚‰ã€<br>ç”»é¢ã®ã‚¹ãƒ­ãƒ¼ãƒœã‚¿ãƒ³ï¼ˆã¾ãŸã¯Sã‚­ãƒ¼ï¼‰ã‚’æŠ¼ã—ã¾ã—ã‚‡ã†ã€‚<br>ä¸€æ™‚çš„ã«é‡ã®å‹•ããŒé…ããªã‚Šã€ç¢ºå®Ÿã«ç‹™ãˆã¾ã™ï¼<br>ï¼ˆâ€»1ãƒ—ãƒ¬ã‚¤ã”ã¨ã®å›æ•°ã«åˆ¶é™ãŒã‚ã‚Šã¾ã™ï¼‰";
        } else if(type === 'fever') {
            title.innerText = "ğŸŒŸ ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«: ãƒ•ã‚£ãƒ¼ãƒãƒ¼";
            desc.innerHTML = "ç†±ç‹‚ã®<span style='color:#ffeb3b; font-weight:bold;'>ã€Œãƒ•ã‚£ãƒ¼ãƒãƒ¼ã€</span>æ©Ÿèƒ½ãŒè§£æ”¾ã•ã‚Œã¾ã—ãŸï¼<br><br>æˆåŠŸã‚’é‡ã­ã¦ã‚²ãƒ¼ã‚¸ãŒMAXã«ãªã‚‹ã¨çªå…¥ã—ã¾ã™ï¼<br>ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã¯ç„¡æ•µã«ãªã‚Šã€<br>é€£æ‰“ã—ãŸåˆ†ã ã‘å¤§é‡ã®ãƒã‚¤ãƒ³ãƒˆã‚’ç¨¼ã’ã¾ã™ï¼<br>ï¼ˆâ€»ãƒŸã‚¹ã™ã‚‹ã¨ã‚²ãƒ¼ã‚¸ãŒå°‘ã—æ¸›ã£ã¦ã—ã¾ã„ã¾ã™ï¼‰";
        }
        
        // ä»–ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’æ¶ˆã•ãšã«ã€ä¸Šã«é‡ã­ã¦è¡¨ç¤ºã™ã‚‹
        modal.style.display = 'block';
    }
    
    function closeTutorial() {
        playBtn();
        document.getElementById('modal-tutorial').style.display = 'none';
        // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’é–‹ãå‰ã®ãƒãƒ¼ã‚ºçŠ¶æ…‹ã«æˆ»ã™ï¼ˆå‹æ‰‹ã«ã‚²ãƒ¼ãƒ ãŒå†é–‹ã™ã‚‹ã®ã‚’é˜²ãï¼‰
        state.isPaused = wasPausedBeforeTutorial;
    }

    function init() {
        if(state.isPlaying) return;
        state.isPlaying=true; state.isPaused=false; 
        state.isFever=false; state.feverG=0; state.pending=0;
        state.combo=0; state.score=0; state.gameSpd=0.05;
        state.direction=1; state.hasDeath=false;
        
        state.life = isA('life') ? 1 + skills.life.lv : 1;
        state.tempLife = 0; 
        state.slowC = isA('slow') ? skills.slow.lv + (skills.slow.lv>=3 ? skills.slow.lv-2 : 0) : 0;
        
        state.isBoss = false; 
        state.bossShieldLeft = isA('bossShield') ? skills.bossShield.lv : 0;
        canvas.classList.remove('boss-active');
        particles = [];
        
        state.buffs.oil = 0; state.buffs.pot = 0; state.buffs.qTimer = false; 
        state.buffs.cushion = 0; state.buffs.magnet = 0; state.buffs.last = false;
        state.heartTimer = 0; state.ticketTimer = 0;
        renderConsumeSidebar();

        setTargetBaseW();
        
        document.getElementById('pending-box').style.visibility='visible';
        document.getElementById('row-withdraw').style.visibility='visible';
        
        document.getElementById('overlay-msg').style.display='none';
        document.getElementById('ending-txt').style.display='none';
        document.getElementById('score-display').innerText = "0";
        document.getElementById('score-display').style.color = "#ff0055";

        if (!state.hasTutorialDone) {
            document.getElementById('click-here-msg').innerText = "CLICK HERE! â†“";
            document.getElementById('click-here-msg').style.display = 'block';
        } else {
            document.getElementById('click-here-msg').style.display = 'none';
        }
        
        applyFont(); setTarget(); updateUI();
    }

    function setTargetBaseW() {
        state.targetW = 0.7;
        if(isA('wide')) state.targetW += skills.wide.lv * 0.05;
        if(isA('widePlus')) state.targetW += skills.widePlus.lv * 0.05;
    }

    function setTarget() {
        state.targetA = Math.random()*Math.PI*2;
        state.critOff = (Math.random()-0.5)*(state.targetW*0.6);
        
        let reverseProb = 0.3;
        if(isA('antiReverse')) reverseProb -= skills.antiReverse.lv * 0.1;
        if(reverseProb < 0) reverseProb = 0;

        if(state.score >= 50 && Math.random() < reverseProb) {
            state.direction = -1;
        } else {
            state.direction = 1;
        }

        state.hasDeath = false;
        if(state.score >= 75 && Math.random() < 0.3) {
            state.hasDeath = true;
            state.deathW = 0.3; 
            if(Math.random() < 0.5) {
                state.deathA = (state.targetA + state.targetW/2 + state.deathW/2) % (Math.PI*2);
            } else {
                state.deathA = (state.targetA - state.targetW/2 - state.deathW/2 + Math.PI*2) % (Math.PI*2);
            }
        }

        if(state.buffs.magnet > 0) { state.targetW = Math.PI * 2; state.hasDeath = false; }
        else if(isA('godMode')) { state.targetW = Math.PI * 2; state.hasDeath = false; }
    }

    function triggerSlow() {
        if(state.isPlaying && !state.isPaused && !state.isFever && state.slowC > 0 && !state.isSlow) {
            state.slowC--; state.isSlow = true; 
            state.slowTimer = (skills.slow.lv >= 2 ? 2000 : 1000);
            updateUI();
        }
    }

    function togglePause() {
        if(!state.isPlaying) return;
        state.isPaused = !state.isPaused;
        const ov = document.getElementById('overlay-msg');
        const txt = document.getElementById('pause-txt');
        if(state.isPaused) { ov.style.display='flex'; txt.style.display='block'; }
        else { ov.style.display='none'; txt.style.display='none'; }
    }

    let isTikuwaSpinning = false;
    document.getElementById('tikuwa-img').onclick = function() {
        if(!state.isPlaying || state.isPaused || isTikuwaSpinning) return;
        isTikuwaSpinning = true;
        playTone('sine', 1500, 0.1); setTimeout(()=>playTone('triangle', 2000, 0.2), 100);
        this.style.transform = 'rotate(360deg) scale(1.5)'; this.style.transition = 'transform 0.3s';
        
        let gain = 100;
        if(state.ticketTimer > 0) gain *= 2;
        state.pending += gain; updateUI(); showFloatingText("+" + gain, "#ffeb3b");
        
        setTimeout(() => { 
            this.style.transition = 'none'; 
            this.style.transform = 'rotate(0deg) scale(1)'; 
            setTimeout(() => isTikuwaSpinning = false, 50); 
        }, 300);
    };

    function handleInput() {
        if(!state.isPlaying || state.isPaused) { if(!state.isPlaying) init(); return; }
        
        if (state.hasTutorialDone) document.getElementById('click-here-msg').style.display = 'none';

        if(state.isFever) {
            let ptsM = isA('pts') ? 1 + skills.pts.lv : 1;
            if(isA('ptsPlus')) ptsM *= (1 + skills.ptsPlus.lv); 
            let fbM = isA('feverBoost') ? 1 + skills.feverBoost.lv * 0.2 : 1;
            let fgain = ptsM * 1.5 * fbM;
            if(state.ticketTimer > 0) fgain *= 2;
            state.pending += fgain; 
            playHit(false,true); 
            showFloatingText("+" + Math.floor(fgain), "#ffeb3b");
            if(state.skin.effect==='thunder') drawThunder(); 
            if(state.skin.effect==='particle') generateParticles();
            updateUI(); return;
        }

        let isDeathClick = false;
        if (state.hasDeath) {
            let dDiff = Math.abs(state.angle - state.deathA);
            if(dDiff > Math.PI) dDiff = (Math.PI*2) - dDiff;
            if(dDiff <= state.deathW/2 + 0.05) isDeathClick = true;
        }

        if (isDeathClick) {
            playTone('sawtooth', 50, 1.0);
            showFloatingText("INSTANT DEATH!", "#0055ff");
            state.life = 0; state.tempLife = 0;
            if(state.buffs.cushion > 0) {
                state.buffs.cushion--; renderConsumeSidebar();
                showFloatingText("CUSHION!", "#00ffcc");
                forceWithdraw();
            } else {
                gameOver();
            }
            return;
        }

        let diff = Math.abs(state.angle - state.targetA);
        if(diff>Math.PI) diff=(Math.PI*2)-diff;
        
        let cDiff = Math.abs(state.angle - (state.targetA+state.critOff));
        if(cDiff>Math.PI) cDiff=(Math.PI*2)-cDiff;
        let isCritArea = (isA('crit') && cDiff<=(state.targetW*0.15));
        let isCritRandom = (isA('critRate') && Math.random() < (skills.critRate.lv * 0.002));
        let isCrit = isCritArea || isCritRandom;

        let isSuccess = (diff <= state.targetW/2 + 0.05);

        if(!isSuccess && state.isBoss && state.bossShieldLeft > 0) {
            isSuccess = true; state.bossShieldLeft--; playTone('triangle', 1200, 0.2); 
        }

        if(isSuccess) {
            if (!state.hasTutorialDone) {
                state.hasTutorialDone = true;
                showFloatingText("NICE!", "#00ffcc");
                document.getElementById('click-here-msg').style.display = 'none';
            }

            state.score++; state.combo++;
            
            if(state.score > state.maxScore) state.maxScore = state.score;
            if(state.combo > state.maxCombo) state.maxCombo = state.combo;

            if(state.buffs.magnet > 0) {
                state.buffs.magnet--; renderConsumeSidebar();
            }

            if(state.score === 100) { 
                state.hasReached100 = true; 
                if(isA('ending')) { playEnding(); }
            }
            
            let gain = isA('pts') ? 1 + skills.pts.lv : 1;
            if(isA('ptsPlus')) gain *= (1 + skills.ptsPlus.lv); 

            // â–¼ ã‚³ãƒ³ãƒœãƒœãƒ¼ãƒŠã‚¹å€ç‡ã®ä¸Šæ–¹ä¿®æ­£ï¼ˆ1ã‚³ãƒ³ãƒœã”ã¨ã«+3%å¢—åŠ ã™ã‚‹ï¼‰
            if(isA('comboBonus')) gain *= 1 + (state.combo * 0.03 * skills.comboBonus.lv); 
            
            if(state.isBoss) {
                let bossCount = Math.floor(state.score / 10);
                gain += 50 * bossCount; 
                if(state.score > 1) { playTone('triangle', 1000, 0.2); setTimeout(()=>playTone('triangle', 1200, 0.4), 100); }
            }
            
            if(isCrit) gain *= 1.5;
            
            let lRate = isA('lucky') ? 0.005 : 0;
            if(state.buffs.pot > 0) lRate += 0.15 * state.buffs.pot;
            if(lRate > 0 && Math.random() < lRate) { 
                gain *= 3; playTone('square', 1500, 0.5); showFloatingText("LUCKY!", "#ff0055");
                if(state.buffs.pot > 0) { state.buffs.pot--; renderConsumeSidebar(); } 
            }
            
            if(state.ticketTimer > 0) gain *= 2;
            if(isA('godMode')) gain *= 10;

            state.pending += gain;
            showFloatingText("+" + Math.floor(gain), isCrit ? "#ffeb3b" : "#fff");
            
            playHit(isCrit,false);
            if(isCrit && state.skin.effect==='thunder') drawThunder();
            if(state.skin.effect==='particle') generateParticles();
            
            if(isA('fever')) {
                state.feverG += (isCrit ? 4 : 2) + (skills.fever.lv * 0.5);
                if(state.feverG>=100) { startFever(); }
            }

            if(state.buffs.last || (state.score > 0 && state.score%10===0)) {
                state.isBoss = true; 
                let bLv = Math.floor(state.score / 10);
                if(state.buffs.last) bLv += 3; 
                
                state.targetW = Math.max(state.buffs.last ? 0.1 : 0.2, 0.7 - (bLv * 0.05)); 
                state.bossSpeed = 0.01 + (bLv * 0.005); 
                
                if(isA('bossSlow') && Math.random() < skills.bossSlow.lv * 0.2) {
                    state.isSlow = true; state.slowTimer = (skills.slow.lv >= 2 ? 2000 : 1000);
                }
            } else {
                state.isBoss = false;
                let wBase = 0.7;
                if(isA('wide')) wBase += skills.wide.lv*0.05;
                if(isA('widePlus')) wBase += skills.widePlus.lv*0.05;
                let shrink = state.score * 0.005;
                if(isA('wideKeep')) shrink -= state.score * (skills.wideKeep.lv * 0.0005);
                state.targetW = Math.max(0.15, wBase - shrink);
            }

            let spdInc = 0.002;
            if(isA('gear')) {
                spdInc = skills.gear.lv <= 5 ? 0.002 - (skills.gear.lv * 0.0002) : 0.0010 * Math.pow(0.9, skills.gear.lv - 5);
            }
            state.gameSpd += spdInc;

            if(!state.isFever) {
                document.getElementById('score-display').innerText = state.score;
                document.getElementById('mobile-score-display').innerText = state.score;
            }
            setTarget();

            // --- ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«åˆ¤å®š ---
            if (state.score === 5 && !state.tutorials.withdraw) {
                state.tutorials.withdraw = true;
                setTimeout(() => showTutorial('withdraw'), 300);
            }
            if (state.score === 9 && !state.tutorials.boss) {
                state.tutorials.boss = true;
                setTimeout(() => showTutorial('boss'), 300);
            }

        } else {
            if(isA('recovery') && Math.random() < skills.recovery.lv * 0.1) {
                playTone('sine', 800, 0.2); setTarget(); 
            } else {
                if (state.tempLife > 0) { state.tempLife--; }
                else { state.life--; }

                state.combo=0;
                state.gameSpd = Math.max(0.05, state.gameSpd - 0.01); 
                state.feverG = Math.max(0, state.feverG - 10); 
                
                if(state.life <= 0 && state.tempLife <= 0) {
                    if(state.buffs.cushion > 0) {
                        state.buffs.cushion--; renderConsumeSidebar();
                        showFloatingText("CUSHION!", "#00ffcc"); playTone('triangle', 1500, 0.5);
                        forceWithdraw();
                    } else {
                        gameOver();
                    }
                } else { 
                    playTone('sawtooth',150,0.3); setTarget(); 
                }
            }
        }
        updateUI();
    }

    function startFever() {
        state.isFever=true; state.feverG = 100;
        playTone('square',1200,0.5); 
        document.getElementById('score-display').innerText="FEVER"; 
        document.getElementById('score-display').style.color="#ffeb3b";
        document.getElementById('mobile-score-display').innerText="FEVER"; 
        document.getElementById('mobile-score-display').style.color="#ffeb3b";
        if(state.isSlow) { state.isSlow=false; state.slowTimer=0; }
        updateUI();
    }

function gameOver() {
    state.isPlaying=false; state.isFever=false; state.isPaused=false;
    state.isBoss=false; canvas.classList.remove('boss-active'); 
    
    state.buffs.oil = 0; state.buffs.qTimer = false; state.tempLife = 0;
    state.buffs.last = false;
    if(state.buffs.pot > 0) state.buffs.pot = 0; 

    playTone('sawtooth',80,0.6);
    let ins = isA('ins') ? 15 + skills.ins.lv*10 : 15;
    state.pts += Math.min(state.pending, ins);
    
    document.getElementById('score-display').innerText = "LOST";
    document.getElementById('mobile-score-display').innerText = "LOST";
    
    document.getElementById('pending-box').style.visibility='hidden';
    document.getElementById('row-withdraw').style.visibility='hidden';

    document.getElementById('click-here-msg').style.display = 'none';
    
    renderConsumeSidebar(); updateUI(); updateClocks(true); 

    if (!state.tutorials.upgrade && state.pts >= 20) {
        state.tutorials.upgrade = true;
        setTimeout(() => showTutorial('upgrade'), 800);
    }
}

    function forceWithdraw() {
    playBtn(); state.pts+=state.pending; state.isPlaying=false; 
    
    state.hasTutorialDone = true; 
    document.getElementById('click-here-msg').style.display = 'none';

    document.getElementById('score-display').innerText="SAFE"; 
    document.getElementById('mobile-score-display').innerText="SAFE"; 
    updateUI(); 
    document.getElementById('pending-box').style.visibility='hidden';
    document.getElementById('row-withdraw').style.visibility='hidden';
    state.feverG=0; canvas.className=''; 
    updateClocks(true);

    if (!state.tutorials.upgrade && state.pts >= 20) {
        state.tutorials.upgrade = true;
        setTimeout(() => showTutorial('upgrade'), 800);
    }
}

    let thFrames = 0;
    function drawThunder(){ thFrames=5; }
    
    function generateParticles() {
        for(let i=0; i<20; i++) {
            particles.push({
                x: 140 + Math.cos(state.angle) * 110,
                y: 140 + Math.sin(state.angle) * 110,
                vx: (Math.random() - 0.5) * 10, vy: (Math.random() - 0.5) * 10,
                life: 1.0, color: `hsl(${Math.random()*360}, 100%, 70%)`
            });
        }
    }

    let lastTime = 0;
    function loop(timestamp) {
        if(!lastTime) lastTime = timestamp;
        let deltaTime = timestamp - lastTime;
        lastTime = timestamp;

        if(deltaTime > 50) deltaTime = 16.666; 
        let dtMult = deltaTime / 16.666;

        if(!state.isPlaying || state.isPaused) { requestAnimationFrame(loop); return; }

        ctx.clearRect(0,0,280,280);

        if(state.skin.f_bg) {
            ctx.save(); ctx.strokeStyle = 'rgba(0, 255, 128, 0.2)'; ctx.lineWidth = 1;
            let offset = (Date.now() / 50) % 20;
            for(let i=0; i<=280; i+=20) {
                ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, 280); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(0, i + offset); ctx.lineTo(280, i + offset); ctx.stroke();
            }
            ctx.restore();
        }

        if(state.isSlow) {
            state.slowTimer -= deltaTime;
            if(state.slowTimer <= 0) { state.isSlow = false; }
            document.getElementById('val-slow-timer').innerText = "(" + (state.slowTimer/1000).toFixed(1) + "s)";
        } else { document.getElementById('val-slow-timer').innerText = ""; }

        if(state.heartTimer > 0) {
            state.heartTimer -= deltaTime;
            if(state.heartTimer <= 0) { state.tempLife = 0; updateUI(); }
        }
        if(state.ticketTimer > 0) {
            state.ticketTimer -= deltaTime;
            if(state.ticketTimer <= 0) { renderConsumeSidebar(); }
        }

        if(state.isFever) {
            let fTimeLv = isA('feverTime') ? skills.feverTime.lv : 0;
            let feverDuration = 10000 + (fTimeLv * 1000); 
            state.feverG -= 100 * (deltaTime / feverDuration);
            if(state.feverG<=0) { 
                state.isFever=false; state.feverG = 0;
                document.getElementById('score-display').innerText=state.score;
                document.getElementById('score-display').style.color="#ff0055"; 
                document.getElementById('mobile-score-display').innerText=state.score;
                document.getElementById('mobile-score-display').style.color="#ff0055"; 
                setTarget();
            }
            document.getElementById('fever-bar').style.width = Math.max(0, state.feverG)+'%';
        } else if (state.feverG > 0) {
            state.feverG -= 1.5 * (deltaTime / 1000);
            if (state.feverG < 0) state.feverG = 0;
            document.getElementById('fever-bar').style.width = state.feverG+'%';
        }
        
        canvas.className = '';
        if(state.isFever) canvas.classList.add('fever-active');
        else if(state.isSlow) canvas.classList.add('slow-active');
        else if(state.isBoss) canvas.classList.add('boss-active');

        let shadow = 'none';
        if(state.skin.ring === '#ffd700') shadow = '0 0 30px rgba(255, 215, 0, 0.7)';
        else if(state.skin.ring === '#ffffff') shadow = '0 0 30px rgba(255, 255, 255, 0.7)';
        else if(state.skin.ring === '#ff0055') shadow = '0 0 30px rgba(255, 0, 85, 0.7)';
        canvas.style.boxShadow = shadow;

        ctx.beginPath(); ctx.arc(140,140,110,0,Math.PI*2);
        ctx.strokeStyle = state.isFever ? '#ffeb3b' : state.skin.ring;
        ctx.lineWidth = 15; ctx.stroke();

        ctx.beginPath();
        if(state.isFever) {
            ctx.arc(140,140,110,0,Math.PI*2); ctx.strokeStyle = `hsl(${Date.now()%360},${state.settings.feverSat}%,50%)`;
        } else {
            if(state.isBoss) { 
                state.targetA += state.bossSpeed * state.bossDir * dtMult; 
                if(Math.random()<0.02 * dtMult) state.bossDir*=-1; 
            }
            ctx.arc(140,140,110,state.targetA-state.targetW/2, state.targetA+state.targetW/2);
            ctx.strokeStyle='#ff0055';
        }
        ctx.stroke();

        if(isA('crit') && !state.isFever) {
            ctx.beginPath(); let cw = state.targetW*0.3;
            ctx.arc(140,140,110,(state.targetA+state.critOff)-cw/2, (state.targetA+state.critOff)+cw/2);
            ctx.strokeStyle='#ffeb3b'; ctx.stroke();
        }

        if(state.hasDeath && !state.isFever) {
            ctx.beginPath();
            ctx.arc(140, 140, 110, state.deathA - state.deathW/2, state.deathA + state.deathW/2);
            ctx.strokeStyle = '#0055ff'; ctx.lineWidth = 15; ctx.stroke();
            let dx = 140 + Math.cos(state.deathA)*110; let dy = 140 + Math.sin(state.deathA)*110;
            ctx.font = "16px Arial"; ctx.fillStyle = "#fff"; ctx.fillText("ğŸ’€", dx - 10, dy + 6);
        }

        let currentSpd = state.gameSpd * Math.pow(1.5, state.buffs.oil);
        
        if (!state.hasTutorialDone && state.score === 0) {
            let tDiff = Math.abs(state.angle - state.targetA);
            if(tDiff>Math.PI) tDiff=(Math.PI*2)-tDiff;
            if (tDiff <= state.targetW/2 + 0.05) {
                document.getElementById('click-here-msg').style.color = "#ff0055";
                document.getElementById('click-here-msg').style.transform = "translateX(-50%) scale(1.2)";
                currentSpd = 0; 
            } else {
                document.getElementById('click-here-msg').style.color = "#ffeb3b";
                document.getElementById('click-here-msg').style.transform = "translateX(-50%) scale(1)";
                currentSpd = 0.02; 
            }
        }

        let step = (state.isSlow ? currentSpd*0.3 : currentSpd) * state.direction * dtMult;
        state.angle = (state.angle + step + Math.PI*2) % (Math.PI*2);
        
        if (state.skin.needle === 'real_needle') {
            ctx.save(); ctx.translate(140, 140); ctx.rotate(state.angle);
            const img = document.getElementById('needle-img');
            if (img.complete && img.naturalHeight !== 0) { ctx.drawImage(img, -10, -110, 20, 110); } 
            else { ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(110,0); ctx.strokeStyle='#ffd700'; ctx.lineWidth=4; ctx.stroke(); }
            ctx.restore();
        } else {
            ctx.beginPath(); ctx.moveTo(140,140);
            ctx.lineTo(140+Math.cos(state.angle)*110, 140+Math.sin(state.angle)*110);
            ctx.strokeStyle = '#fff'; ctx.lineWidth=4; ctx.stroke();
        }

        if(thFrames>0) {
            ctx.beginPath(); ctx.moveTo(140,140);
            for(let i=0;i<5;i++) ctx.lineTo(140+(Math.random()-0.5)*200, 140+(Math.random()-0.5)*200);
            ctx.strokeStyle='rgba(255,255,255,0.8)'; ctx.lineWidth=2; ctx.stroke(); thFrames--;
        }

        for(let i=particles.length-1; i>=0; i--) {
            let p = particles[i];
            p.x += p.vx * dtMult; p.y += p.vy * dtMult; p.life -= 0.03 * dtMult;
            ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2);
            ctx.fillStyle = p.color; ctx.globalAlpha = Math.max(0, p.life); ctx.fill();
            ctx.globalAlpha = 1.0;
            if(p.life <= 0) particles.splice(i, 1);
        }

        requestAnimationFrame(loop);
    }

    function updateUI() {
        document.getElementById('ui-pts').innerText = Math.floor(state.pts);
        
        let pendingText = Math.floor(state.pending);
        document.getElementById('ui-pending').innerText = pendingText;
        document.getElementById('mobile-pending-display').innerText = pendingText; 

        document.getElementById('ui-ins').innerText = isA('ins') ? 15 + skills.ins.lv*10 : 15;
        
        document.getElementById('rec-score').innerText = state.maxScore;
        document.getElementById('rec-combo').innerText = state.maxCombo;

        let lHtml = '';
        let baseLife = isA('life') ? 1 + skills.life.lv : 1;
        let cBase = state.isPlaying ? Math.max(0, state.life) : baseLife;
        let cTemp = state.isPlaying ? state.tempLife : 0;
        
        for(let i=0; i<cBase; i++) { lHtml += '<div class="life-box"></div>'; }
        for(let i=0; i<cTemp; i++) { lHtml += '<div class="life-box temp"></div>'; }
        
        document.getElementById('val-life').innerHTML = lHtml;
        document.getElementById('mobile-val-life').innerHTML = lHtml; 

        document.getElementById('val-spd').innerText = ((state.buffs.oil>0 ? state.gameSpd*Math.pow(1.5, state.buffs.oil) : state.gameSpd)*20).toFixed(1);
        document.getElementById('val-slow').innerText = state.isPlaying?state.slowC : (isA('slow') ? skills.slow.lv + (skills.slow.lv>=3 ? skills.slow.lv-2 : 0) : 0);
        
        if(isA('bossShield')) {
            document.getElementById('shield-wrapper').style.display = 'flex';
            document.getElementById('val-shield').innerText = state.isPlaying ? state.bossShieldLeft : skills.bossShield.lv;
        } else {
            document.getElementById('shield-wrapper').style.display = 'none';
        }

        document.getElementById('fever-container').style.visibility = isA('fever') ? 'visible' : 'hidden';
        document.getElementById('slow-wrapper').style.display = isA('slow') ? 'flex' : 'none';
        
        document.getElementById('guide-slow').style.display = isA('slow') ? 'inline' : 'none';
        document.getElementById('mobile-slow-btn').style.display = isA('slow') ? 'block' : 'none';

        document.getElementById('btn-play-ending').style.display = isA('ending') ? 'block' : 'none';

        document.querySelectorAll('.modal-pts-display').forEach(el => el.innerText = Math.floor(state.pts));

        updateClocks();
    }

    function openModal(id) { 
        document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); 
        
        if(id === 'modal-upgrade' || id === 'modal-shop') {
            document.getElementById(id).style.display='flex'; 
        } else {
            document.getElementById(id).style.display='block'; 
        }

        if(id === 'modal-upgrade') {
            renderSkills();
        }
        if(id === 'modal-shop') {
            let hasToybox = isA('toybox');
            document.getElementById('shop-tabs').style.display = hasToybox ? 'flex' : 'none';
            if(!hasToybox) state.shopTab = 'skin';
            changeShopTab(state.shopTab, false);

            if(!state.tutorials.shop) {
                state.tutorials.shop = true;
                setTimeout(() => showTutorial('shop'), 300);
            }
        }
        if(id === 'modal-status') renderStatus();
    }

    function closeAllModals() {
        playBtn(); 
        document.querySelectorAll('.modal').forEach(m=>m.style.display='none');
    }
    
    function toggleSkill(k) {
        playBtn(); skills[k].active = !skills[k].active; updateUI(); renderSkills();
    }

    function renderSkills() {
        const div = document.getElementById('list-upgrade'); div.innerHTML = '';
        let total = Object.values(skills).reduce((a,b)=>a+b.lv,0);
        
        document.getElementById('modal-total-lv').innerText = total;

        const categories = [
            { id: 'basic', name: 'ğŸ”µ åŸºæœ¬å¼·åŒ–' },
            { id: 'rng', name: 'ğŸŸ  ç¢ºç‡ãƒ»ç‰¹æ®Š' },
            { id: 'system', name: 'ğŸŸ£ ã‚·ã‚¹ãƒ†ãƒ ãƒ»è£œåŠ©' },
            { id: 'boss', name: 'ğŸ”´ ãƒœã‚¹å¯¾ç­–' },
            { id: 'fever', name: 'ğŸŸ¡ ãƒ•ã‚£ãƒ¼ãƒãƒ¼' },
            { id: 'toybox', name: 'ğŸ“¦ ã‚·ãƒ§ãƒƒãƒ—å¼·åŒ–' },
            { id: 'god', name: 'âšª ï¼Ÿï¼Ÿï¼Ÿ' }
        ];

        let html = '';

        categories.forEach(cat => {
            let catSkills = Object.keys(skills).filter(k => skills[k].cat === cat.id && !skills[k].parent);
            if(catSkills.length === 0) return;

            if(cat.id === 'god' && !state.hasReached100 && skills.ending.lv === 0) {
                html += `<div class="skill-category-title" style="border-left-color: #444; color: #777;">âšª ï¼Ÿï¼Ÿï¼Ÿ</div>`;
            } else {
                let catColor = getCatColor(cat.id);
                let catName = cat.id === 'god' ? 'âšª ç¥ã®é ˜åŸŸ' : cat.name;
                html += `<div class="skill-category-title" style="border-left-color: ${catColor}; color: ${catColor};">${catName}</div>`;
            }

            catSkills.forEach(k => {
                html += createSkillRowHTML(k, total, false);
                let children = Object.keys(skills).filter(childKey => skills[childKey].parent === k);
                children.forEach(childKey => {
                    html += createSkillRowHTML(childKey, total, true);
                });
            });
        });

        div.innerHTML = html;
    }

    function createSkillRowHTML(k, totalLv, isChild) {
        const s = skills[k];
        let locked = totalLv < s.tier;
        let lockReason = `åˆè¨ˆLv${s.tier}ã§è§£æ”¾`;

        if(k==='ending') {
            locked = !state.hasReached100;
            lockReason = "ã‚¹ã‚³ã‚¢100åˆ°é”ã§è§£æ”¾";
        } else if(k==='antiReverse') {
            locked = state.maxScore < 50;
            lockReason = "æœ€å¤§ã‚¹ã‚³ã‚¢50é”æˆã§è§£æ”¾";
        } else if(s.parent) {
            if(skills[s.parent].lv === 0) {
                locked = true;
                lockReason = `å‰æã‚¹ã‚­ãƒ«å–å¾—ã§è§£æ”¾`;
            }
        }

        const cost = getCost(s); 
        let maxVal = (isA('limitBreak') && s.isLB) ? 999 : (s.defaultMax || s.max);
        const max = s.lv >= maxVal;
        
        const alwaysVisible = ['crit', 'slow', 'bossShield', 'fever'];
        const isSecret = locked && !alwaysVisible.includes(k);

        let titleName = isSecret ? 'ï¼Ÿï¼Ÿï¼Ÿ' : s.name;
        let icon = isSecret ? 'â“' : (s.icon || 'âœ¨');
        let descText = isSecret ? 'æ¡ä»¶ã‚’æº€ãŸã™ã¨è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™' : s.desc;
        let flavorText = isSecret ? '' : `"${s.flavor}"`;
        
        if(isChild && !isSecret) titleName = 'â†³ ' + titleName;
        if(isChild && isSecret) titleName = 'â†³ ï¼Ÿï¼Ÿï¼Ÿ';

        let lvText = max ? 'MAX' : `Lv.${s.lv}/${maxVal}`;
        let toggleHtml = (s.lv > 0 && !s.noToggle) ? `<button class="toggle-btn ${s.active?'on':''}" onclick="toggleSkill('${k}')">${s.active?'ON':'OFF'}</button>` : '';
        let catColor = getCatColor(s.cat);

        let lockBadgeHTML = locked ? `<div class="lock-badge" style="margin-bottom:0;">ğŸ”’ ${lockReason}</div>` : '';
        let childStyle = isChild ? `border-left: 4px solid #555; background: #151515;` : `border-left: 4px solid ${catColor};`;

        let effectText = '';
        if (!isSecret) {
            let curTxt = getEffectVal(k, s.lv);
            let nxtTxt = max ? 'MAX' : getEffectVal(k, s.lv + 1);
            effectText = `<div class="list-effect-box">åŠ¹æœ: ${curTxt} <span style="color:#aaa;">â†’</span> ${nxtTxt}</div>`;
        } else {
            effectText = `<div class="list-effect-box secret">åŠ¹æœ: ï¼Ÿï¼Ÿï¼Ÿ</div>`;
        }

        return `<div class="list-row" style="opacity:${locked?0.5:1}; ${childStyle}">
            <div class="list-row-top">
                <div class="list-title">
                    <div class="skill-icon-box">${icon}</div>
                    <div class="list-title-wrapper">
                        <div>${titleName} <span style="color:#ffeb3b; font-size:12px; margin-left:4px;">${lvText}</span></div>
                    </div>
                </div>
                ${lockBadgeHTML}
            </div>
            
            <div class="list-desc-wrapper">
                <div class="list-desc">${descText}</div>
                ${flavorText ? `<div class="list-flavor">${flavorText}</div>` : ''}
            </div>

            ${effectText}
            <div class="list-bottom">
                <div>${toggleHtml}</div>
                <button class="list-btn" ${locked||max||state.pts<cost?'disabled':''} onclick="buySkill('${k}')">${max?'MAX':cost+'p'}</button>
            </div>
        </div>`;
    }

    function changeShopTab(tab, playSound=true) {
        if(playSound) playBtn(); 
        state.shopTab = tab;
        document.getElementById('tab-skin').className = tab==='skin' ? "shop-tab-btn active" : "shop-tab-btn";
        document.getElementById('tab-item').className = tab==='item' ? "shop-tab-btn active" : "shop-tab-btn";
        
        if(tab === 'skin') {
            document.getElementById('btn-reset-looks').style.display = 'inline-block';
            document.getElementById('skin-caution').style.display = 'block';
        } else {
            document.getElementById('btn-reset-looks').style.display = 'none';
            document.getElementById('skin-caution').style.display = 'none';
        }

        renderShop();

        if(tab === 'item' && !state.tutorials.consume) {
            state.tutorials.consume = true;
            setTimeout(() => showTutorial('consume'), 300);
        }
    }

    function renderShop() {
        const div = document.getElementById('list-shop'); div.innerHTML = '';
        
        if (state.shopTab === 'skin') {
            for(let k in shopItems) {
                const i = shopItems[k]; const has = owned.includes(k);
                
                let isEquipped = false;
                if(i.type==='skin' && state.skin.ring===i.val) isEquipped = true;
                if(i.type==='effect' && state.skin.effect===i.val) isEquipped = true;
                if(i.type==='sound' && state.skin.sound===i.val) isEquipped = true;
                if(i.type==='needle' && state.skin.needle===i.val) isEquipped = true;
                if((i.type==='gadget'||i.type==='item'||i.type==='font'||i.type==='facility') && state.skin[k]) isEquipped = true;

                div.innerHTML += `<div class="list-row" style="${has?'border-left: 4px solid #00ffcc; background:#0a2222;':'border-left: 4px solid #444;'}">
                    <div class="list-row-top">
                        <div class="list-title">
                            <div class="skill-icon-box">${i.icon}</div>
                            <div class="list-title-wrapper">
                                <div>${i.name} <span style="font-size:12px; color:#ccc;">${isEquipped ? 'è£…å‚™ä¸­' : (has ? 'æ‰€æŒ' : '')}</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="list-desc-wrapper">
                        <div class="list-desc">${i.desc}</div>
                        <div class="list-flavor">"${i.flavor}"</div>
                    </div>
                    <div class="list-bottom">
                        <div style="font-size:12px; font-weight:bold; color:#ffeb3b;">${has ? '' : i.cost + ' Pt'}</div>
                        ${has?`<button class="list-btn" onclick="useItem('${k}')" style="background:${isEquipped?'#ff0055':'#444'};color:#fff">${isEquipped?'å¤–ã™':'è£…å‚™'}</button>`
                        :`<button class="list-btn" onclick="buyItem('${k}')" ${state.pts<i.cost?'disabled':''}>è³¼å…¥</button>`}
                    </div>
                </div>`;
            }
        } else {
            for(let k in consumeItems) {
                const i = consumeItems[k];
                let disabled = state.pts < i.cost;
                let btnTxt = 'è³¼å…¥';
                if(k === 'c_timer' && !isA('auto')) { disabled = true; btnTxt = 'æ™‚è¨ˆå¿…é ˆ'; }

                div.innerHTML += `<div class="list-row" style="border-left: 4px solid #ff55cc;">
                    <div class="list-row-top">
                        <div class="list-title">
                            <div class="skill-icon-box"><img src="${i.img}" style="width:100%;height:100%;object-fit:contain;"></div>
                            <div class="list-title-wrapper">
                                <div>${i.name} <span style="font-size:12px;color:#ff55cc;">(æ‰€æŒ: ${state.consumes[k]})</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="list-desc-wrapper">
                        <div class="list-desc">${i.desc}</div>
                        <div class="list-flavor">"${i.flavor}"</div>
                    </div>
                    <div class="list-bottom">
                        <div style="font-size:12px; font-weight:bold; color:#ffeb3b;">${i.cost} Pt</div>
                        <button class="list-btn" onclick="buyConsume('${k}')" ${disabled?'disabled':''}>${btnTxt}</button>
                    </div>
                </div>`;
            }
        }
    }

    function renderConsumeSidebar() {
        if(!isA('toybox')) return;
        const div = document.getElementById('consume-list'); div.innerHTML = '';
        let hasItem = false;
        for(let k in consumeItems) {
            if(state.unlockedConsumes[k]) {
                hasItem = true;
                let bKey = k.substring(2); 
                let bVal = state.buffs[bKey];
                let isActive = bVal > 0 || bVal === true;
                let isUnique = (k === 'c_timer' || k === 'c_cushion' || k === 'c_last');
                let actClass = isActive ? (isUnique ? " active-buff-unique" : " active-buff") : "";
                
                let countTxt = (bVal > 1) ? ` (x${bVal})` : "";
                if(isActive && k==='c_ticket' && state.ticketTimer>0) countTxt = ` (${Math.ceil(state.ticketTimer/1000)}s)`;
                if(isActive && k==='c_heart' && state.heartTimer>0) countTxt = ` (${Math.ceil(state.heartTimer/1000)}s)`;
                if(isActive && k==='c_magnet' && state.buffs.magnet>0) countTxt = ` (æ®‹ã‚Š${state.buffs.magnet}å›)`;

                let imgTag = consumeItems[k].img ? `<img src="${consumeItems[k].img}" alt="icon">` : '';
                div.innerHTML += `<button class="consume-item-btn${actClass}" onclick="useConsumeInGame('${k}')" ${state.consumes[k] === 0 ? 'disabled' : ''}>
                    <div style="display:flex; align-items:center;">
                        <div class="item-icon-box" style="width:24px; height:24px; border-radius:4px; margin-right:8px;">${imgTag}</div>
                        <div style="text-align:left;"><span>${consumeItems[k].name}</span><span style="color:#ffeb3b; font-size:12px;">${countTxt}</span><br><span style="font-size:10px;font-weight:normal;color:#aaa">${consumeItems[k].short}</span></div> 
                    </div>
                    <span style="color:${state.consumes[k] > 0 ? '#ffeb3b' : '#777'}; font-size:18px;">x${state.consumes[k]}</span></button>`;
            }
        }
        document.getElementById('consume-area').style.display = hasItem ? 'flex' : 'none';
    }

    function useConsumeInGame(k) {
        if(!state.isPlaying || state.isPaused) return;
        
        if(state.consumes[k] > 0) {
            let bKey = k.substring(2);
            if(k === 'c_timer' && state.buffs.qTimer) return;
            if(k === 'c_cushion' && state.buffs.cushion > 0) return;
            if(k === 'c_last') {
                if(state.buffs.last) return;
                if(state.life + state.tempLife !== 1) {
                    showFloatingText("ä½¿ç”¨ä¸å¯", "#ff0055");
                    playTone('sawtooth', 200, 0.3);
                    return;
                }
            }

            state.consumes[k]--;
            
            if(k === 'c_heart') {
                state.tempLife++; state.heartTimer = 60000; playTone('triangle', 1200, 0.2); showFloatingText("LIFE+1", "#ffeb3b");
            } else if (k === 'c_pot') {
                state.buffs.pot++; playTone('sine', 1500, 0.2); showFloatingText("ãƒ©ãƒƒã‚­ãƒ¼UP!", "#ff5500");
            } else if (k === 'c_oil') {
                state.buffs.oil++; playTone('sine', 1500, 0.2); showFloatingText("SPEED UP!", "#fff"); 
            } else if (k === 'c_timer') {
                state.buffs.qTimer = true; playTone('sine', 1500, 0.2); showFloatingText("CLOCK x2!", "#00ffcc"); updateClocks(true); 
            } else if (k === 'c_cushion') {
                state.buffs.cushion++; playTone('sine', 1200, 0.2); showFloatingText("é˜²è­·ç™ºå‹•!", "#00ffcc");
            } else if (k === 'c_ticket') {
                state.ticketTimer += 60000; state.buffs.ticket++; playTone('triangle', 2000, 0.5); showFloatingText("ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³!", "#ffd700");
            } else if (k === 'c_magnet') {
                state.buffs.magnet += 5; playTone('sawtooth', 800, 0.2); showFloatingText("ãƒã‚°ãƒãƒƒãƒˆãƒ‘ãƒ¯ãƒ¼!", "#ff0055"); setTarget();
            } else if (k === 'c_last') {
                state.buffs.last = true; playTone('square', 200, 0.5); showFloatingText("èƒŒæ°´!", "#ff0055"); setTarget();
            }
            renderConsumeSidebar(); updateUI();
        }
    }

    function renderStatus() {
        let totalLv = Object.values(skills).reduce((a,b)=>a+b.lv,0);
        let ptsMult = isA('pts') ? 1 + skills.pts.lv : 1;
        if(isA('ptsPlus')) ptsMult *= (1 + skills.ptsPlus.lv); 
        
        let critChance = isA('critRate') ? (skills.critRate.lv * 0.2).toFixed(1) : 0;
        let fTime = isA('feverTime') ? 10 + skills.feverTime.lv : 10;
        let fBoost = isA('feverBoost') ? 1.5 * (1 + skills.feverBoost.lv * 0.2) : 1.5;
        let areaW = 0.7;
        if(isA('wide')) areaW += skills.wide.lv * 0.05;
        if(isA('widePlus')) areaW += skills.widePlus.lv * 0.05;
        let bSlow = isA('bossSlow') ? skills.bossSlow.lv * 20 : 0;
        
        let lRateBase = isA('lucky') ? 0.5 : 0;
        let lRatePot = (state.buffs.pot > 0) ? 15 * state.buffs.pot : 0;
        let luckyChance = lRateBase + lRatePot;
        
        let godText = "";
        if (skills.ending.lv > 0) {
            godText = `<p><strong>â–  ç¥ã®é ˜åŸŸ</strong>: ${isA('godMode') ? "<span style='color:#ffeb3b'>è§£æ”¾æ¸ˆ (å¸¸æ™‚ON)</span>" : (skills.godMode.lv>0?"<span style='color:#777'>ç„¡åŠ¹åŒ–ä¸­</span>":"æœªè§£æ”¾")}</p>`;
            godText += `<p><strong>â–  é™ç•Œçªç ´</strong>: ${isA('limitBreak') ? "<span style='color:#ff0055'>è§£æ”¾æ¸ˆ</span>" : (skills.limitBreak.lv>0?"<span style='color:#777'>ç„¡åŠ¹åŒ–ä¸­</span>":"æœªè§£æ”¾")}</p>`;
        } else {
            godText = `<p><strong>â–  ï¼Ÿï¼Ÿï¼Ÿ</strong>: <span style="color:#777">æœªè§£æ”¾</span></p>`;
        }

        let html = `
            <p><strong>â–  ç·åˆãƒ¬ãƒ™ãƒ«</strong>: ${totalLv}</p>
            <p><strong>â–  åˆæœŸãƒ©ã‚¤ãƒ•</strong>: ${isA('life') ? 1 + skills.life.lv : 1}</p>
            <p><strong>â–  åŸºç¤Ptå€ç‡</strong>: x${ptsMult}</p>
            <p><strong>â–  çš„ã®åºƒã•(ãƒ™ãƒ¼ã‚¹)</strong>: ${areaW.toFixed(2)}</p>
            <p><strong>â–  ãƒ©ãƒƒã‚­ãƒ¼ç¢ºç‡</strong>: ${luckyChance.toFixed(1)}%</p>
            <p><strong>â–  ãƒ•ã‚£ãƒ¼ãƒãƒ¼æ™‚é–“</strong>: ${isA('fever') ? fTime + "ç§’" : "æœªè§£æ”¾"}</p>
            <p><strong>â–  ãƒ•ã‚£ãƒ¼ãƒãƒ¼å€ç‡</strong>: ${isA('fever') ? "x"+fBoost.toFixed(1) : "æœªè§£æ”¾"}</p>
            <p><strong>â–  ãƒ©ãƒ³ãƒ€ãƒ ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ç‡</strong>: ${critChance}%</p>
            <p><strong>â–  ãƒœã‚¹æˆ¦ã‚¹ãƒ­ãƒ¼ç™ºå‹•ç‡</strong>: ${bSlow}%</p>
            <p><strong>â–  å‰²å¼•ç‡</strong>: ${isA('discount') ? [0,5,10,25,25][skills.discount.lv] : 0}%</p>
            <p><strong>â–  ã‚ªãƒ¼ãƒˆæ™‚è¨ˆ</strong>: ${isA('auto') ? (1+Math.floor((skills.auto.lv-1)/5)) : 0} æ ç¨¼åƒä¸­</p>
            <hr style="border:0; border-top:1px solid #333; margin:10px 0;">
            ${godText}
        `;
        document.getElementById('status-content').innerHTML = html;
    }

    function buySkill(k){ 
        const s=skills[k]; const c=getCost(s); 
        if(state.pts>=c){ 
            playBtn(); state.pts-=c; s.lv++; updateUI(); renderSkills(); 
            if(k==='ending') playEnding(); 
            
            // --- ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«è¡¨ç¤ºã®è¿½åŠ  ---
            if(k === 'slow' && s.lv === 1 && !state.tutorials.slow) {
                state.tutorials.slow = true;
                setTimeout(() => showTutorial('slow'), 300);
            }
            if(k === 'fever' && s.lv === 1 && !state.tutorials.fever) {
                state.tutorials.fever = true;
                setTimeout(() => showTutorial('fever'), 300);
            }
        } 
    }
    
    function buyItem(k){ 
        if(state.pts>=shopItems[k].cost){ 
            playRezi(); 
            state.pts-=shopItems[k].cost; owned.push(k); updateUI(); checkGadgets(); renderShop(); 
        } 
    }
    
    function buyConsume(k){ 
        if(state.pts>=consumeItems[k].cost){ 
            playRezi(); 
            state.pts-=consumeItems[k].cost; state.consumes[k]++; state.unlockedConsumes[k] = true; updateUI(); renderShop(); renderConsumeSidebar(); 
        } 
    }
    
    function useItem(k){
        const i=shopItems[k]; playBtn();
        if(i.type==='skin') state.skin.ring = (state.skin.ring===i.val ? '#333' : i.val);
        else if(i.type==='effect') state.skin.effect = (state.skin.effect===i.val ? 'none' : i.val);
        else if(i.type==='sound') state.skin.sound = (state.skin.sound===i.val ? 'default' : i.val);
        else if(i.type==='needle') state.skin.needle = (state.skin.needle===i.val ? 'default' : i.val);
        else if(i.type==='gadget' || i.type==='item' || i.type==='font' || i.type==='facility') state.skin[k] = !state.skin[k];
        applyFont(); checkGadgets(); renderShop();
    }
    
    function resetLooks(){ state.skin={ring:'#333',effect:'none',sound:'default',needle:'default',f_bg:false}; applyFont(); checkGadgets(); renderShop(); }

    function playEnding() {
        document.querySelectorAll('.modal').forEach(m=>m.style.display='none');
        document.getElementById('overlay-msg').style.display='flex'; 
        const txt = document.getElementById('ending-txt');
        txt.style.display='block'; txt.style.animation = 'none'; void txt.offsetWidth; 
        txt.style.animation = 'scrollUp 15s linear forwards, shine 3s linear infinite';
        
        // ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°éŸ³å£°ã‚’å†ç”Ÿï¼ˆå¤±æ•—æ™‚ã¯é›»å­éŸ³ï¼‰
        sEnd.volume = state.settings.vol;
        sEnd.currentTime = 0;
        sEnd.play().catch(() => playTone('triangle', 600, 3));

        for(let i=0; i<150; i++) {
            let conf = document.createElement('div');
            conf.style.position = 'fixed';
            conf.style.left = Math.random() * 100 + 'vw';
            conf.style.top = -10 - Math.random() * 20 + 'vh';
            conf.style.width = Math.random()*10+5 + 'px';
            conf.style.height = Math.random()*10+5 + 'px';
            conf.style.backgroundColor = `hsl(${Math.random()*360}, 100%, 50%)`;
            conf.style.zIndex = '300';
            conf.style.transform = `rotate(${Math.random()*360}deg)`;
            conf.style.pointerEvents = 'none';
            document.body.appendChild(conf);

            let duration = 3000 + Math.random() * 3000;
            conf.animate([
                { transform: `translate3d(0, 0, 0) rotate(0deg)` },
                { transform: `translate3d(${Math.random()*300-150}px, 120vh, 0) rotate(${Math.random()*1080}deg)` }
            ], { duration: duration, easing: 'linear', fill: 'forwards' });

            setTimeout(() => conf.remove(), duration);
        }

        setTimeout(() => { document.getElementById('overlay-msg').style.display='none'; txt.style.display='none'; }, 15000);
    }

    let clkInt=[];
    function updateClocks(forceRebuild = false){
        const c=document.getElementById('clock-sidebar');
        const num=isA('auto') ? 1+Math.floor((skills.auto.lv-1)/5) : 0;
        if(c.childElementCount!==num || skills.auto.lv%5===1 || forceRebuild){
            c.innerHTML=''; clkInt.forEach(clearInterval); clkInt=[];
            if(num>0){
                let spdMs = 10000 - ((skills.auto.lv-1)%5)*1800;
                if(state.buffs.qTimer) spdMs /= 2; 
                for(let i=0;i<num;i++){
                    const d=document.createElement('div'); d.className='mini-clock';
                    d.innerHTML=`<style>.mini-clock::after{animation-duration:${spdMs/1000}s}</style>`;
                    c.appendChild(d);
                    clkInt.push(setInterval(()=>{ 
                        if(!state.isPaused && state.isPlaying){ 
                            let gain = 1;
                            if(isA('autoEff')) gain += 9 + (skills.autoEff.lv - 1) * 10;
                            if(state.ticketTimer > 0) gain *= 2;
                            state.pts += gain; updateUI(); 
                            if(state.settings.showNum) {
                                let rect = d.getBoundingClientRect();
                                let el = document.createElement('div'); el.innerText = "+"+gain; el.className = 'floating-text'; el.style.color = '#00ffcc'; el.style.fontSize = '14px';
                                el.style.left = rect.left + 'px'; el.style.top = rect.top + 'px'; el.style.position = 'fixed';
                                document.body.appendChild(el); setTimeout(() => el.remove(), 1000);
                            }
                        } 
                    }, spdMs));
                }
            }
        }
    }
    
    // æ‹›ãçŒ«ã®å®šæœŸçš„ãƒã‚¤ãƒ³ãƒˆç²å¾—
    setInterval(() => {
        if (state.skin['g_neko'] && state.isPlaying && !state.isPaused) {
            state.pts += 1;
            updateUI();
            let gd = document.getElementById('gd-neko');
            if (gd) {
                gd.style.transform = 'translateY(-10px)';
                setTimeout(() => gd.style.transform = 'translateY(0)', 200);
            }
        }
    }, 2000);

    function checkGadgets(){
        document.getElementById('gd-btn').style.display = state.skin['g_btn'] ? 'flex' : 'none';
        document.getElementById('gd-metro').style.display = state.skin['g_met'] ? 'flex' : 'none';
        document.getElementById('gd-bomb').style.display = state.skin['g_bomb'] ? 'flex' : 'none';
        document.getElementById('gd-neko').style.display = state.skin['g_neko'] ? 'flex' : 'none';
        document.getElementById('tikuwa-img').style.display = state.skin['i_tikuwa'] ? 'block' : 'none';
        renderConsumeSidebar();
    }

    document.getElementById('gd-btn').onclick=function(){ 
        sInterhon.volume=state.settings.vol; sInterhon.currentTime=0; 
        sInterhon.play().catch(()=>playTone('triangle',800,0.5)); 
    };
    
    let mId=null;
    document.getElementById('gd-metro').onclick=function(){
        if(mId){ clearInterval(mId); mId=null; this.style.borderColor='#555'; }
        else { this.style.borderColor='#00ffcc'; mId=setInterval(()=>playTone('square',1200,0.05),500); }
    };
    document.getElementById('gd-bomb').onclick=function(){
        playTone('sawtooth', 100, 0.8);
        const b = document.getElementById('bomb-gif');
        b.src = 'bakuhatu.gif?' + new Date().getTime();
        b.style.display = 'block';
        setTimeout(() => b.style.display = 'none', 1000);
    };

    document.getElementById('pause-btn').onclick = togglePause;
    
    /* ã‚­ãƒ£ãƒ³ãƒã‚¹ã®å³ã‚¯ãƒªãƒƒã‚¯ï¼ˆé•·æŠ¼ã—ï¼‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å®Œå…¨ã«ç„¡åŠ¹åŒ– */
    canvas.addEventListener('contextmenu', (e) => { e.preventDefault(); });

    canvas.addEventListener('mousedown', (e)=>{ e.preventDefault(); handleInput(); });
    canvas.addEventListener('touchstart', (e)=>{ e.preventDefault(); handleInput(); }, {passive: false});

    /* ã‚¹ãƒãƒ›å°‚ç”¨ã‚¿ãƒƒãƒ—ãƒ»ã‚¹ãƒ­ãƒ¼ãƒœã‚¿ãƒ³ã®å‡¦ç† */
    const tapBtn = document.getElementById('mobile-tap-btn');
    tapBtn.addEventListener('mousedown', (e)=>{ e.preventDefault(); handleInput(); });
    tapBtn.addEventListener('touchstart', (e)=>{ e.preventDefault(); handleInput(); }, {passive: false});

    const slowBtn = document.getElementById('mobile-slow-btn');
    slowBtn.addEventListener('mousedown', (e)=>{ e.preventDefault(); triggerSlow(); });
    slowBtn.addEventListener('touchstart', (e)=>{ e.preventDefault(); triggerSlow(); }, {passive: false});

    window.addEventListener('keydown', (e)=>{ 
        if(e.code==='Space'){ e.preventDefault(); if(!e.repeat) handleInput(); } 
        if((e.code==='KeyS' || e.key==='s')){ e.preventDefault(); if(!e.repeat) triggerSlow(); } 
        if(e.code==='Escape'){ togglePause(); } 
    });
    
    document.getElementById('btn-withdraw').onclick=(e)=>{ forceWithdraw(); };
    
    document.getElementById('btn-upgrade').onclick=()=>{ playBtn(); openModal('modal-upgrade'); };
    document.getElementById('btn-shop').onclick=()=>{ playBtn(); openModal('modal-shop'); };
    document.getElementById('btn-help').onclick=()=>{ playBtn(); openModal('modal-help'); };
    document.getElementById('btn-sys').onclick=()=>{ playBtn(); openModal('modal-sys'); };
    document.getElementById('btn-status').onclick=()=>{ playBtn(); openModal('modal-status'); };

    function confirmFullReset(){ 
        playBtn(); 
        document.getElementById('modal-sys').style.display = 'none';
        document.getElementById('modal-confirm').style.display = 'block'; 
    }
    
    function closeConfirmModal(){
        playBtn();
        document.getElementById('modal-confirm').style.display = 'none';
        document.getElementById('modal-sys').style.display = 'block'; 
    }

    function executeFullReset(){ 
        playTone('sawtooth', 100, 0.5);
        localStorage.clear(); 
        location.reload(); 
    }

    // --- âœ¨ ã‚»ãƒ¼ãƒ–ãƒ»ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ï¼ˆã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–å¯¾å¿œï¼‰ âœ¨ ---
    function saveGame(s, silent=false){ 
        try {
            localStorage.setItem('tl_pc_'+s, JSON.stringify({
                pts:state.pts, skills, owned, skin:state.skin, reach100:state.hasReached100, hasTutorialDone:state.hasTutorialDone, 
                tutorials:state.tutorials,
                consumes:state.consumes, unlockedConsumes:state.unlockedConsumes, sets:state.settings, 
                recS:state.maxScore, recC:state.maxCombo
            })); 
            if(!silent) alert("ä¿å­˜ã—ã¾ã—ãŸ"); 
        } catch(e) { console.error("Save Error", e); }
    }
    
    function loadGame(s, silent=false){
        const d=JSON.parse(localStorage.getItem('tl_pc_'+s));
        if(d){ 
            state.pts=d.pts || 0; owned=d.owned || []; state.skin=d.skin; state.hasReached100=d.reach100||false;
            if(d.hasTutorialDone !== undefined) state.hasTutorialDone = d.hasTutorialDone;
            if(d.tutorials) state.tutorials = { ...state.tutorials, ...d.tutorials };
            if(d.recS) state.maxScore = d.recS; if(d.recC) state.maxCombo = d.recC;
            
            if(d.consumes) state.consumes = { ...state.consumes, ...d.consumes };
            if(d.unlockedConsumes) state.unlockedConsumes = d.unlockedConsumes;
            else { for(let k in state.consumes) if(state.consumes[k] > 0) state.unlockedConsumes[k] = true; }

            if(d.sets) { 
                state.settings = d.sets; 
                if(state.settings.feverSat === undefined) state.settings.feverSat = 100;
                document.getElementById('vol-se').value = state.settings.vol; 
                document.getElementById('vol-sat').value = state.settings.feverSat;
                let btn = document.getElementById('toggle-num-btn'); btn.innerText = state.settings.showNum ? "ON" : "OFF"; btn.className = state.settings.showNum ? "toggle-btn on" : "toggle-btn"; 
            }
            Object.keys(skills).forEach(k=>{
                if(d.skills[k]){ skills[k].lv=d.skills[k].lv; if(d.skills[k].active !== undefined) skills[k].active=d.skills[k].active; }
            }); 
            applyFont(); updateUI(); checkGadgets(); 
            if(!silent) alert("ãƒ­ãƒ¼ãƒ‰å®Œäº†"); 
        } else {
            if(!silent) alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
        }
    }

    // 5ç§’ã”ã¨ã«ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§è‡ªå‹•ã‚»ãƒ¼ãƒ–
    setInterval(() => {
        if(state.hasTutorialDone || state.score > 0 || state.pts > 0) {
            saveGame('auto', true);
        }
    }, 5000);

    // èµ·å‹•æ™‚ã«è‡ªå‹•ã§ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
    window.addEventListener('DOMContentLoaded', () => {
        loadGame('auto', true);
    });
    
    document.getElementById('vol-se').oninput=(e)=>{ state.settings.vol = e.target.value; };
    document.getElementById('vol-sat').oninput=(e)=>{ state.settings.feverSat = parseInt(e.target.value); };

    setInterval(() => {
        if(state.isPlaying && !state.isPaused && (state.ticketTimer > 0 || state.heartTimer > 0)) {
            renderConsumeSidebar();
        }
    }, 1000);

    requestAnimationFrame(loop);
</script>
</body>
</html>